<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QAlgorithms: src/qalgorithms_qpeaks.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">QAlgorithms
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">qalgorithms_qpeaks.cpp</div></div>
</div><!--header-->
<div class="contents">
<a href="qalgorithms__qpeaks_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">// qalgorithms_qpeaks.cpp</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">//</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">// internal</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="preprocessor">#include &quot;<a class="code" href="qalgorithms__qpeaks_8h.html">../include/qalgorithms_qpeaks.h</a>&quot;</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span> </div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">// external</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span> </div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceq.html">q</a></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span>{</div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#pragma region Constructors</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span>  <span class="comment">// Constructor</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#a401e618cceed5b32fae8b6e9e5e57005">   12</a></span>  <a class="code hl_function" href="classq_1_1q_peaks.html#a401e618cceed5b32fae8b6e9e5e57005">qPeaks::qPeaks</a>() {}</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span> </div>
<div class="foldopen" id="foldopen00014" data-start="{" data-end="}">
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#a2d61ca92c700c43e8bfcb573326748dc">   14</a></span>  <a class="code hl_function" href="classq_1_1q_peaks.html#a401e618cceed5b32fae8b6e9e5e57005">qPeaks::qPeaks</a>(<span class="keyword">const</span> <a class="code hl_typedef" href="namespaceq.html#a4dea617c66f5c5dfc66e60e2e128f5da">varDataType</a> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataVec</a>)</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span>  {</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>    std::visit(</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>        [<span class="keyword">this</span>](<span class="keyword">auto</span> &amp;&amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">arg</a>)</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span>        {</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>          <span class="comment">/*</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">          // get the largest number of data points in a single data set within the dataVec</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">          int maxDataPoints = 0;</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="comment">          // iterate over the map of varDataType datatype objects</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">            for (auto &amp;pair : *arg)</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="comment">            {</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="comment">              // de-reference the unique pointer of the object</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="comment">              auto &amp;dataObj = *(pair.get());</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">              // iterate over data point vector, which is a vector of unique pointers to data points structures</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="comment">              auto &amp;data = dataObj.dataPoints;</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">              // compare the size of the data vector to the maxDataPoints variable</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="comment">              if (data.size() &gt; maxDataPoints)</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="comment">              {</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="comment">                // if the size of the data vector is larger than the maxDataPoints variable, set the maxDataPoints variable to the size of the data vector</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="comment">                maxDataPoints = data.size();</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span><span class="comment">              }</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="comment">            }</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="comment">          int maxScale = (int) (maxDataPoints-1)/2;</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="comment">          */</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>          this-&gt;global_maxScale = 30;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>          <span class="comment">// iterate over the range of the maxScale to create Matrices for each scale</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> scale = 2; scale &lt;= this-&gt;global_maxScale; scale++)</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>          {</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>            createDesignMatrix(scale);</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>            createInverseAndPseudoInverse(*(designMatrices.back()));</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>          }</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>        },</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataVec</a>);</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>  }</div>
</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="preprocessor">#pragma endregion Constructors</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span> </div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="preprocessor">#pragma region Destructor</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>  <span class="comment">// Destructor</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#a6fe1f39896e39558ac88cbeb7fab5a6c">   52</a></span>  <a class="code hl_function" href="classq_1_1q_peaks.html#a6fe1f39896e39558ac88cbeb7fab5a6c">qPeaks::~qPeaks</a>() {}</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="preprocessor">#pragma endregion Destructor</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span> </div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="preprocessor">#pragma region Methods</span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="preprocessor">#pragma region findPeaks</span></div>
<div class="foldopen" id="foldopen00057" data-start="{" data-end="}">
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#a84e1e2fe8b7b0434b682b28803297477">   57</a></span>  std::vector&lt;std::vector&lt;std::unique_ptr&lt;DataType::Peak&gt;&gt;&gt; <a class="code hl_function" href="classq_1_1q_peaks.html#a84e1e2fe8b7b0434b682b28803297477">qPeaks::findPeaks</a>(</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>      <span class="keyword">const</span> <a class="code hl_typedef" href="namespaceq.html#a4dea617c66f5c5dfc66e60e2e128f5da">varDataType</a> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataVec</a>)</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>  {</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>    std::vector&lt;std::vector&lt;std::unique_ptr&lt;DataType::Peak&gt;&gt;&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">all_peaks</a>;</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>    std::visit(</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>        [&amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">all_peaks</a>, <span class="keyword">this</span>](<span class="keyword">auto</span> &amp;&amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">arg</a>)</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>        {</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">all_peaks</a>.resize(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">arg</a>-&gt;size());</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>      <span class="comment">// iterate over the map of varDataType datatype objects</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>      <span class="comment">// use parallel for loop to iterate over the dataVec</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="preprocessor">#pragma omp parallel for</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">arg</a>-&gt;size(); <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>          {</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>            <span class="comment">// de-reference the unique pointer of the object</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>            <span class="keyword">auto</span> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">pair</a> =  (*arg)[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>];</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>            <span class="keyword">auto</span> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataObj</a> = *(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">pair</a>.get());</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>            <span class="keyword">auto</span> &amp;data = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataObj</a>.dataPoints;</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>            <span class="keywordtype">int</span> n = data.size();</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>            <span class="comment">// store x and y values in RefMatrix objects</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>            <span class="comment">// RefMatrix X(n, 1);</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>            <a class="code hl_class" href="classq_1_1_ref_matrix.html">RefMatrix</a> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>(n, 1);</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>            std::vector&lt;double*&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>(n);</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>            std::vector&lt;int*&gt; df(n);</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>            {</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>              <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>] = &amp;data[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>]-&gt;x();</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>              df[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>] = &amp;data[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>]-&gt;df;</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>              <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.assignRef(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, 0, data[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>]-&gt;y());</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>            }</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>            std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>; <span class="comment">// index in B, scale, apex_position and MSE</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>            runningRegression(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, df, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>);</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.empty())</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            {</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>              <span class="keywordflow">continue</span>; <span class="comment">// no valid peaks</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>            }</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>            <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">all_peaks</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>] = createPeaks(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataObj</a>.getScanNumber());</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>          } <span class="comment">// end parallel for loop</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>        ; },</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dataVec</a>); <span class="comment">// end visit</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">all_peaks</a>;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>  } <span class="comment">// end findPeaks</span></div>
</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span><span class="preprocessor">#pragma endregion findPeaks</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span> </div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span><span class="preprocessor">#pragma region runningRegression</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>  <span class="keywordtype">void</span> qPeaks::runningRegression(</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>      <span class="keyword">const</span> <a class="code hl_class" href="classq_1_1_ref_matrix.html">RefMatrix</a> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>      <span class="keyword">const</span> std::vector&lt;int *&gt; &amp;df,</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>      std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>)</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>  {</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>    <span class="comment">// perform log-transform on Y</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>    <span class="keywordtype">size_t</span> n = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.getRows();</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>    <a class="code hl_class" href="classq_1_1_matrix.html">Matrix</a> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.<a class="code hl_function" href="classq_1_1_matrix.html#a34a6a5e87cf0b5a9eb832caaec1b9ab4">log</a>();</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span> </div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">maxScale</a> = std::min(this-&gt;global_maxScale, (<span class="keywordtype">int</span>)(n - 1) / 2);</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.reserve(calculateNumberOfRegressions(n));</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> scale = 2; scale &lt;= <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">maxScale</a>; scale++)</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    {</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>      <span class="comment">// coeffiencts matrix B of the running regression</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>      <a class="code hl_class" href="classq_1_1_matrix.html">Matrix</a> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>.<a class="code hl_function" href="classq_1_1_matrix.html#aceb7f09f0eea5817c7e46d7cdbb7870d">convoleCombiend</a>(*(psuedoInverses[scale - 2]));</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>      validateRegressions(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>, df, scale, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>);</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>    } <span class="comment">// end for scale loop</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>    mergeRegressionsOverScales(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, df);</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>  } <span class="comment">// end runningRegression</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span><span class="preprocessor">#pragma endregion runningRegression</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span> </div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span><span class="preprocessor">#pragma region validateRegressions</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>  <span class="keywordtype">void</span> qPeaks::validateRegressions(</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>      <span class="keyword">const</span> Matrix &amp;B,</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>      <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>      <span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>,</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>      <span class="keyword">const</span> std::vector&lt;int *&gt; &amp;df,</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>      <span class="keyword">const</span> <span class="keywordtype">int</span> scale,</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>      std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>)</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>  {</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>    <span class="comment">// declare constants</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">index_offset</a> = (<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>.numRows() - <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> * (<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 1) + 2;</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>    <span class="comment">// declare variables</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> = 0;</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a>;</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    <span class="keywordtype">double</span> apex_position;</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">inverseMatrix_2_2</a> = (*(inverseMatrices[<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2]))(2, 2);  <span class="comment">// variance of the quadratic term left side of the peak</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">inverseMatrix_3_3</a> = (*(inverseMatrices[<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2]))(3, 3);  <span class="comment">// variance of the quadratic term right side of the peak</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>    Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> = *(designMatrices[<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2]);                          <span class="comment">// design matrix</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(1, 4);                                      <span class="comment">// Jacobian matrix for the height</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>; <span class="comment">// temporary vector to store valid regressions &lt;index, apex_position&gt;</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span> </div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>    <span class="comment">// iterate columwise over the coefficients matrix</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; B.numCols(); <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>    {</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="comment">        Degree of Freedom Filter:</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="comment">        This block of code implements the degree of freedom filter. It calculates the degree of freedom based df vector. If the degree of freedom is less than 5, the loop continues to the next iteration. The value 5 is chosen as the minimum number of data points required to fit a quadratic regression model.</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="comment">      */</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> = std::transform_reduce(</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>          df.begin() + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>,</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>          df.begin() + 2 * scale + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>,</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>          0,</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>          std::plus&lt;&gt;(),</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>          [](<span class="keywordtype">int</span> *<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">p</a>)</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>          { return *p; });</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span> </div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> &lt; 5)</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>      {</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>        <span class="keywordflow">continue</span>; <span class="comment">// degree of freedom less than 5; i.e., less then 5 measured data points</span></div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>      }</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span> </div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span><span class="comment">        Apex and Valley Position Filter:</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="comment">        This block of code implements the apex and valley position filter. It calculates the apex and valley positions based on the coefficients matrix B. If the apex is outside the data range, the loop continues to the next iteration. If the apex and valley positions are too close to each other, the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span><span class="comment">      */</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>      <span class="comment">// calculate the checksum for case differentiation</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">key</a> = (B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) &lt; 0 ? 4 : 0) + (B(2, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) &lt; 0 ? 2 : 0) + (B(3, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) &lt; 0 ? 1 : 0);</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>      <span class="keywordflow">switch</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">key</a>)</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>      {</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>      <span class="keywordflow">case</span> 7:                                   <span class="comment">// Case 1a: apex left</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        apex_position = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(2, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>); <span class="comment">// is negative</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> = 0;                    <span class="comment">// no valley point</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>        <span class="keywordflow">if</span> (apex_position &lt;= -scale + 1)        <span class="comment">// scale +1: prevent appex position to be at the edge of the data</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>        {</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>          <span class="keywordflow">continue</span>; <span class="comment">// invalid apex position</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>        }</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>      <span class="keywordflow">case</span> 3:                                   <span class="comment">// Case 1b: apex right</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>        apex_position = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(3, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>); <span class="comment">// is positive</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> = 0;                    <span class="comment">// no valley point</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>        <span class="keywordflow">if</span> (apex_position &gt;= scale - 1)         <span class="comment">// scale -1: prevent appex position to be at the edge of the data</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>        {</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>          <span class="keywordflow">continue</span>; <span class="comment">// invalid apex position</span></div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>        }</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>      <span class="keywordflow">case</span> 6:                                                                    <span class="comment">// Case 2a: apex left | valley right</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>        apex_position = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(2, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);                                  <span class="comment">// is negative</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(3, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);                                <span class="comment">// is positive</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>        <span class="keywordflow">if</span> (apex_position &lt;= -scale + 1 || <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> - apex_position &lt;= 2) <span class="comment">// scale +1: prevent appex position to be at the edge of the data</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>        {</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>          <span class="keywordflow">continue</span>; <span class="comment">// invalid apex and valley positions</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>        }</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>      <span class="keywordflow">case</span> 1:                                                                   <span class="comment">// Case 2b: apex right | valley left</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>        apex_position = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(3, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);                                 <span class="comment">// is positive</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> = -B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) / 2 / B(2, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);                               <span class="comment">// is negative</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>        <span class="keywordflow">if</span> (apex_position &gt;= scale - 1 || apex_position - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> &lt;= 2) <span class="comment">// scale -1: prevent appex position to be at the edge of the data</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>        {</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>          <span class="keywordflow">continue</span>; <span class="comment">// invalid apex and valley positions</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>        }</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>      <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>        <span class="keywordflow">continue</span>; <span class="comment">// invalid case</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>      } <span class="comment">// end switch</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span> </div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span><span class="comment">        Quadratic Term Filter:</span></div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="comment">        This block of code implements the quadratic term filter. It calculates the mean squared error (MSE) between the predicted and actual values. Then it calculates the t-value for the quadratic term. If the t-value is less than the corresponding value in the tValuesArray, the quadratic term is considered statistically insignificant, and the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="comment">      */</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>      <span class="keyword">const</span> Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> * B.col(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>); <span class="comment">// predicted values</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>      <span class="keywordtype">double</span> mse = calcMse(             <span class="comment">// mean squared error</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>,</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>          (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>.subMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + 2 * scale + 1, 0, 1)));</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>      <span class="comment">// adjust mse by considering the real df</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>      mse *= (2 * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 3) / (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 4);</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">tValue</a> = std::max(                                    <span class="comment">// t-value for the quadratic term</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>          std::abs(B(2, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)) / std::sqrt(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">inverseMatrix_2_2</a> * mse),  <span class="comment">// t-value for the quadratic term left side of the peak</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>          std::abs(B(3, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)) / std::sqrt(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">inverseMatrix_3_3</a> * mse)); <span class="comment">// t-value for the quadratic term right side of the peak</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">tValue</a> &lt; <a class="code hl_variable" href="namespaceq.html#a1ec04afafe30778c469db879d2b596ff">tValuesArray</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 5])                       <span class="comment">// df is df_sum-4 but tValuesArray is zero-based</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>      {</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>        <span class="keywordflow">continue</span>; <span class="comment">// statistical insignificance of the quadratic term</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>      }</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span> </div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="comment">        Height Filter:</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="comment">        This block of code implements the height filter. It calculates the height of the peak based on the coefficients matrix B. Then it calculates the uncertainty of the height based on the Jacobian matrix and the variance-covariance matrix of the coefficients. If the height is statistically insignificant, the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span><span class="comment">      */</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>      <span class="keywordtype">double</span> height = std::exp(B(0, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) + apex_position * B(1, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) * .5);</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 0) = height;</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 1) = apex_position * height;</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>      <span class="keywordflow">if</span> (apex_position &lt; 0)</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>      {</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 2) = apex_position * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 1);</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 3) = 0;</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>      }</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>      {</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 2) = 0;</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 3) = apex_position * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>(0, 1);</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>      }</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">C</a> = (*inverseMatrices[<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2]) * mse; <span class="comment">// variance-covariance matrix of the coefficients</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">h_uncertainty</a> = std::sqrt((<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">C</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_height</a>.T()).sumElements());</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>      <span class="keywordflow">if</span> (height / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">h_uncertainty</a> &lt; <a class="code hl_variable" href="namespaceq.html#a1ec04afafe30778c469db879d2b596ff">tValuesArray</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 5])</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>      {</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>        <span class="keywordflow">continue</span>; <span class="comment">// statistical insignificance of the height</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>      }</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span> </div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="comment">        Area Filter:</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="comment">        This block of code implements the area filter. It calculates the Jacobian matrix for the peak area based on the coefficients matrix B. Then it calculates the uncertainty of the peak area based on the Jacobian matrix. If the peak area is statistically insignificant, the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="comment">      */</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>      std::pair&lt;Matrix, Matrix&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a> = jacobianMatrix_PeakArea(B.col(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>), scale); <span class="comment">// first: Jacobian matrix, second: Jacobian matrix for the covered peak area</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>      <span class="keywordtype">double</span> area_uncertainty = std::sqrt(                                                <span class="comment">// uncertainty of the peak area based on the Jacobian matrix and the non-covered peak area</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>          (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.first * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">C</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.first.T()).sumElements());</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span> </div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.first(0, 0) / area_uncertainty &lt; <a class="code hl_variable" href="namespaceq.html#a1ec04afafe30778c469db879d2b596ff">tValuesArray</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 5])</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>      {</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>        <span class="keywordflow">continue</span>; <span class="comment">// statistical insignificance of the peak area</span></div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>      }</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span> </div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="comment">        Covered Area Filter:</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="comment">        This block of code implements the covered area filter. It calculates the covered peak area. Then it calculates the uncertainty of the peak area based on the Jacobian matrix. If the area is statistically insignificant, the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="comment">      */</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">area_uncertainty_covered</a> = std::sqrt( <span class="comment">// uncertainty of the peak area based on the Jacobian matrix and the covered peak area</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>          (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.second * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">C</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.second.T()).sumElements());</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.second(0, 0) / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">area_uncertainty_covered</a> &lt; <a class="code hl_variable" href="namespaceq.html#a1ec04afafe30778c469db879d2b596ff">tValuesArray</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 5])</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>      {</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>        <span class="keywordflow">continue</span>; <span class="comment">// statistical insignificance of the peak area</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>      }</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span> </div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span><span class="comment">        Chi-Square Filter:</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span><span class="comment">        This block of code implements the chi-square filter. It calculates the chi-square value based on the weighted chi squared sum of expected and measured y values in the exponential domain. If the chi-square value is less than the corresponding value in the chiSquareArray, the loop continues to the next iteration.</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span><span class="comment">      */</span></div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">chiSquare</a> = calcChiSquareEXP(</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>,</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.subMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + 2 * scale + 1, 0, 1));</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">chiSquare</a> &lt; <a class="code hl_variable" href="namespaceq.html#a84ad6a8042d2bf8703d3b1291b97953a">chiSquareArray</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 5])</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>      {</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>        <span class="keywordflow">continue</span>; <span class="comment">// statistical insignificance of the chi-square value</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>      }</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span> </div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>      <span class="comment">/*</span></div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span><span class="comment">        Add to a temporary vector of valid regressions:</span></div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span><span class="comment">        This block of code adds the valid peak to a temporary vector of valid regressions. It calculates the left and right limits of the peak based on the valley position. Then it stores the index of the valid regression in the temporary vector of valid regressions.</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span><span class="comment">      */</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>      <span class="comment">// at this point, the peak is validated</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>      <span class="keywordtype">double</span> left_limit = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> &lt; 0) ? std::max((<span class="keywordtype">double</span>)<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>) : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>;</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>      <span class="keywordtype">double</span> right_limit = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> &gt; 0) ? std::min((<span class="keywordtype">double</span>)<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + 2 * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">valley_position</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>) : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + 2 * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>;</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span> </div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.push_back(</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>          std::make_unique&lt;validRegression&gt;(</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>              <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + scale,                                            <span class="comment">// index of the center of the window (x==0) in the Y matrix</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>              scale,                                                <span class="comment">// scale</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>              <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 4,                                           <span class="comment">// df</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>              apex_position + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + scale,                            <span class="comment">// apex position in x-axis 0:n</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>              0,                                                    <span class="comment">// initial MSE</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>              B.col(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>),                                             <span class="comment">// coefficients matrix</span></div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>              <span class="keyword">true</span>,                                                 <span class="comment">// isValid</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>              left_limit,                                           <span class="comment">// left_limit</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>              right_limit,                                          <span class="comment">// right_limit</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>              left_limit - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>,                                       <span class="comment">// X_row_0</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>              right_limit - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> + 1,                                  <span class="comment">// X_row_1</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>              <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">area_uncertainty_covered</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Jacobian_area</a>.second(0, 0) <span class="comment">// dqs</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>              ));</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>      <span class="comment">// std::erf(                  // dqs (experimental)</span></div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>      <span class="comment">//     (1 - std::erf(area_uncertainty / Jacobian_area.first(0, 0))) / (1 - std::erf(1 / tValuesArray[df_sum - 5])) - 1)));</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>    } <span class="comment">// end for loop</span></div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>    <span class="comment">// early return if no or only one valid peak</span></div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.size() &lt; 2)</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>    {</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.empty())</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>      {</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>        <span class="keywordflow">return</span>; <span class="comment">// no valid peaks</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>      }</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.push_back(std::move(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>[0]));</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>      <span class="keywordflow">return</span>; <span class="comment">// not enough peaks to form a group</span></div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>    }</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="comment">      Grouping:</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span><span class="comment">      This block of code implements the grouping. It groups the valid peaks based on the apex positions. Peaks are defined as similar, i.e., members of the same group, if they fullfill at least one of the following conditions:</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span><span class="comment">      - The difference between two peak apexes is less than 4. (Nyquist Shannon Sampling Theorem, separation of two maxima)</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span><span class="comment">      - At least one apex of a pair of peaks is within the window of the other peak. (Overlap of two maxima)</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span><span class="comment">    */</span></div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span> </div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>    std::vector&lt;std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt;&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>; <span class="comment">// vector of vectors of valid regressions, i.e., groups of valid regressions</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span> </div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>    <span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.begin(); <span class="comment">// iterator for the peak</span></div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>    <span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a> = std::next(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak</a>);     <span class="comment">// iterator for the next peak</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span> </div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>    <span class="keywordflow">while</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a> != <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.end()) <span class="comment">// iterate over the temporary vector of valid regressions</span></div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>    {</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>      <span class="comment">// check if the difference between two peak apexes is less than 4 (Nyquist Shannon Sampling Theorem, separation of two maxima), or if the apex of a peak is within the window of the other peak (Overlap of two maxima)</span></div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>      <span class="keywordflow">if</span> (</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>          std::abs((*it_peak)-&gt;apex_position - (*it_peak_next)-&gt;apex_position) &gt; 4 &amp;&amp; <span class="comment">// Nyquist Shannon Sampling Theorem, separation of two maxima</span></div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>          (*it_peak)-&gt;apex_position &lt; (*it_peak_next)-&gt;left_limit &amp;&amp;                  <span class="comment">// Left peak is not within the window of the right peak</span></div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>          (*it_peak_next)-&gt;apex_position &gt; (*it_peak)-&gt;right_limit                    <span class="comment">// Right peak is not within the window of the left peak</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>      )</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>      { <span class="comment">// the two regressions differ, i.e. create a new group and move all regressions from start to it_peak to this group</span></div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span> </div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>.push_back(std::vector&lt;std::unique_ptr&lt;q::qPeaks::validRegression&gt;&gt;());            <span class="comment">// create a new group</span></div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>        std::move(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.begin(), <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a>, std::back_inserter(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>.back())); <span class="comment">// move all regressions from start to it_peak to this group</span></div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.erase(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.begin(), <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a>);               <span class="comment">// erase the moved regressions from the temporary vector of valid regressions</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>      }</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a>;</div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>      ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a>;</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a> == <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.end())</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>      {                                                                                                    <span class="comment">// the last peak is reached</span></div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>.push_back(std::vector&lt;std::unique_ptr&lt;q::qPeaks::validRegression&gt;&gt;());            <span class="comment">// create a new group</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>        std::move(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsTmp</a>.begin(), <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_peak_next</a>, std::back_inserter(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>.back())); <span class="comment">// move all regressions from start to it_peak to this group</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>      }</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>    } <span class="comment">// end while loop</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span> </div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span><span class="comment">      Survival of the Fittest Filter:</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="comment">      This block of code implements the survival of the fittest filter. It selects the peak with the lowest mean squared error (MSE) as the representative of the group. If the group contains only one peak, the peak is directly pushed to the valid regressions. If the group contains multiple peaks, the peak with the lowest MSE is selected as the representative of the group and pushed to the valid regressions.</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="comment">    */</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">group</a> : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressionGroups</a>)</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>    {</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">group</a>.size() == 1)</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>      { <span class="comment">// already isolated peak =&gt; push to valid regressions</span></div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.push_back(std::move(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">group</a>.front()));</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>      }</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>      { <span class="comment">// survival of the fittest based on mse between original data and reconstructed (exp transform of regression)</span></div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>        calcExtendedMse(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">group</a>, df);</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;regression : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">group</a>)</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>        {</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>          <span class="keywordflow">if</span> (<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;isValid)</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>          {</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>            <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.push_back(std::move(regression));</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>          }</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>        }</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>      } <span class="comment">// end if; single item or group with multiple members</span></div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>    } <span class="comment">// end for loop (group in vector of groups)</span></div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>  } <span class="comment">// end validateRegressions</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span><span class="preprocessor">#pragma endregion validateRegressions</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span> </div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span><span class="preprocessor">#pragma region mergeRegressionsOverScales</span></div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>  <span class="keywordtype">void</span> qPeaks::mergeRegressionsOverScales(</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>      std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>,</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>      <span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Ylog</a>,</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>      <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>      <span class="keyword">const</span> std::vector&lt;int *&gt; &amp;df)</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>  {</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.empty())</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>    {</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>      <span class="keywordflow">return</span>; <span class="comment">// no valid peaks at all</span></div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>    }</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span> </div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.size() == 1)</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>    {</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>      <span class="keywordflow">return</span>; <span class="comment">// only one valid regression, i.e., no further grouping required; validRegressions is already fine.</span></div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>    }</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span> </div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span><span class="comment">      Grouping Over Scales:</span></div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span><span class="comment">      This block of code implements the grouping over scales. It groups the valid peaks based on the apex positions. Peaks are defined as similar, i.e., members of the same group, if they fullfill at least one of the following conditions:</span></div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span><span class="comment">      - The difference between two peak apexes is less than 4. (Nyquist Shannon Sampling Theorem, separation of two maxima)</span></div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span><span class="comment">      - At least one apex of a pair of peaks is within the window of the other peak. (Overlap of two maxima)</span></div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span><span class="comment">    */</span></div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>    <span class="comment">// iterate over the validRegressions vector</span></div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_new_peak</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.begin(); <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_new_peak</a> != <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.end(); ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_new_peak</a>)</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>    {</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>      <span class="keywordtype">double</span> left_limit = (*it_new_peak)-&gt;left_limit;             <span class="comment">// left limit of the current peak regression window in the Y matrix</span></div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>      <span class="keywordtype">double</span> right_limit = (*it_new_peak)-&gt;right_limit;           <span class="comment">// right limit of the current peak regression window in the Y matrix</span></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpMSE</a> = 0;                                          <span class="comment">// group mean squared error</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpDF</a> = 0;                                              <span class="comment">// group degree of freedom</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">numPeaksInGroup</a> = 0;                                    <span class="comment">// number of peaks in the group</span></div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>      <span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.begin();                <span class="comment">// iterator for the reference peak, i.e., a valid peak to compare with the new peak</span></div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>      std::vector&lt;<span class="keyword">decltype</span>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a>)&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsInGroup</a>; <span class="comment">// vector of iterators</span></div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span> </div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>      <span class="comment">// iterate over the validRegressions vector till the new peak</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>      <span class="keywordflow">for</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a>; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_new_peak</a>; ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a>)</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>      {</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>        <span class="keywordflow">if</span> (!(*it_ref_peak)-&gt;isValid)</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>        {</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>          <span class="keywordflow">continue</span>; <span class="comment">// skip the invalid peaks</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>        }</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>        <span class="keywordflow">if</span> ( <span class="comment">// check for the overlap of the peaks</span></div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>            (</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>                (*it_ref_peak)-&gt;apex_position &gt; left_limit &amp;&amp;   <span class="comment">// ref peak matches the left limit</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>                (*it_ref_peak)-&gt;apex_position &lt; right_limit) || <span class="comment">// ref peak matches the right limit</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>            (</div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>                (*it_new_peak)-&gt;apex_position &gt; (*it_ref_peak)-&gt;left_limit &amp;&amp; <span class="comment">// new peak matches the left limit</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>                (*it_new_peak)-&gt;apex_position &lt; (*it_ref_peak)-&gt;right_limit)) <span class="comment">// new peak matches the right limit</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>        {</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>          <span class="keywordflow">if</span> ((*it_ref_peak)-&gt;mse == 0.0)</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>          { <span class="comment">// calculate the mse of the ref peak</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>            (*it_ref_peak)-&gt;mse = calcMseEXP(</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>                ((*designMatrices[(*it_ref_peak)-&gt;scale - 2]).subMatrix((*it_ref_peak)-&gt;X_row_0, (*it_ref_peak)-&gt;X_row_1, 0, 4) * (*it_ref_peak)-&gt;B),</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>                (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.subMatrix(</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>                    (*it_ref_peak)-&gt;left_limit,      <span class="comment">// start row index</span></div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>                    (*it_ref_peak)-&gt;right_limit + 1, <span class="comment">// end row index</span></div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>                    0,                               <span class="comment">// start column index</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>                    1))                              <span class="comment">// end column index</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>            );</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>          }</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpDF</a> += (*it_ref_peak)-&gt;df;                        <span class="comment">// add the degree of freedom</span></div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpMSE</a> += (*it_ref_peak)-&gt;mse * (*it_ref_peak)-&gt;df; <span class="comment">// add the sum of squared errors</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">numPeaksInGroup</a>++;                                  <span class="comment">// increment the number of peaks in the group</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>          <span class="comment">// add the iterator of the ref peak to a vector of iterators</span></div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsInGroup</a>.push_back(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a>);</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>        }</div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>      } <span class="comment">// end for loop, inner loop, it_ref_peak</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span> </div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpDF</a> &gt; 0)</div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>      {</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpMSE</a> /= <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpDF</a>;</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>      }</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>      {</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>        <span class="keywordflow">continue</span>; <span class="comment">// no peaks in the group, i.e., the current peak stays valid</span></div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>      }</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span> </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>      <span class="keywordflow">if</span> ((*it_new_peak)-&gt;mse == 0.0)</div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>      { <span class="comment">// calculate the mse of the current peak</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>        (*it_new_peak)-&gt;mse = calcMseEXP(</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>            ((*designMatrices[(*it_new_peak)-&gt;scale - 2]).subMatrix((*it_new_peak)-&gt;X_row_0, (*it_new_peak)-&gt;X_row_1, 0, 4) * (*it_new_peak)-&gt;B),</div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>            (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.subMatrix(</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>                (*it_new_peak)-&gt;left_limit,      <span class="comment">// start row index</span></div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>                (*it_new_peak)-&gt;right_limit + 1, <span class="comment">// end row index</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>                0,                               <span class="comment">// start column index</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>                1))                              <span class="comment">// end column index</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>        );</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>      }</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span> </div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">numPeaksInGroup</a> == 1)</div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>      {</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>        <span class="comment">// calculate the extended MSE using the current peak and the ref peak and set the worse one to invalid</span></div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>        calcExtendedMse(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>, *(*<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_new_peak</a>), (*<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsInGroup</a>[0][0]), df);</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>      }</div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span> </div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>      <span class="keywordflow">if</span> ((*it_new_peak)-&gt;mse &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">grpMSE</a>)</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>      {</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>        <span class="comment">// Set isValid to false for the candidates from the group</span></div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">it_ref_peak</a> : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressionsInGroup</a>)</div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>        {</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>          (*it_ref_peak)-&gt;isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>        }</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>      }</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>      { <span class="comment">// Set isValid to false for the current peak</span></div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>        (*it_new_peak)-&gt;isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>      }</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>    } <span class="comment">// end for loop, outer loop, it_current_peak</span></div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span> </div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>    <span class="comment">// Remove the peaks with isValid == false from the validRegressions</span></div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.erase(std::remove_if(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.begin(), <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.end(),</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>                                          [](<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">peak</a>)</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>                                          { return !peak-&gt;isValid; }),</div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>                           <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>.end());</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>  } <span class="comment">// end mergeRegressionsOverScales</span></div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span><span class="preprocessor">#pragma endregion mergeRegressionsOverScales</span></div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span> </div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span><span class="preprocessor">#pragma region createPeaks</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>  std::vector&lt;std::unique_ptr&lt;DataType::Peak&gt;&gt;</div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>  qPeaks::createPeaks(</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>      <span class="keyword">const</span> std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>,</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>      <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>      <span class="keyword">const</span> std::vector&lt;double *&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>,</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>      <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">scanNumber</a>)</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>  {</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>    std::vector&lt;std::unique_ptr&lt;DataType::Peak&gt;&gt; peaks; <span class="comment">// peak list</span></div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>    <span class="comment">// iterate over the validRegressions vector</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;regression : <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">validRegressions</a>)</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>    {</div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>      <span class="comment">// re-scale the apex position to x-axis</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x0</a> = *<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>[(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">int</a>)std::floor(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;apex_position)];</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dx</a> = *<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>[(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">int</a>)std::ceil(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;apex_position)] - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x0</a>;</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>      <span class="keywordtype">double</span> apex_position = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x0</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dx</a> * (<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;apex_position - std::floor(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;apex_position));</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>      <span class="comment">// create a new peak object and push it to the peaks vector; the peak object is created using the scan number, the apex position and the peak height</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>      peaks.push_back(std::make_unique&lt;DataType::Peak&gt;(</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>          <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">scanNumber</a>,</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span>          apex_position,</div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>          (<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) &gt; 0)</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>              ? std::exp(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(0, 0) - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) * <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) / 4 / <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(3, 0))</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>              : std::exp(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(0, 0) - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) * <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) / 4 / <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(2, 0))));</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>      <span class="comment">// debugging</span></div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span> </div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>      <span class="comment">// get the coefficients matrix</span></div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>      Matrix B = <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B;</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span> </div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>      <span class="comment">// get the index of the regression</span></div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>      <span class="keywordtype">int</span> index = <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0;</div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>      <span class="comment">// get scale</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>      <span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> = <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;scale;</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>      <span class="comment">// design matrix</span></div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Xdesign</a> = (*(designMatrices[<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> - 2])).subMatrix(<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;X_row_0, <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;X_row_1, 0, 4);</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span> </div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>      <span class="comment">// calculate yfit</span></div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit_matrix</a> = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Xdesign</a> * B).exp();</div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>      std::vector&lt;double&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit</a>;</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit_matrix</a>.numRows(); <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>      {</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit</a>.push_back(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit_matrix</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, 0));</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>      }</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>      <span class="comment">// extract xfit, i.e., from X vector index to index + 2*scale+1</span></div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>      std::vector&lt;double&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">xfit</a>;</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;left_limit; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;right_limit + 1; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>      {</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i &lt; 0 || i &gt;</a>= <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>.size())</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>        {</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>          <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>        }</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">xfit</a>.push_back(*<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>]);</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>      }</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span> </div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>      peaks.back()-&gt;xFit = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">xfit</a>;</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>      peaks.back()-&gt;yFit = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yfit</a>;</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span> </div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>      <span class="comment">// std::cout &lt;&lt; &quot;-----------------------------------\n&quot;;</span></div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>      <span class="comment">// std::cout &lt;&lt; &quot;Apex Position: &quot; &lt;&lt; apex_position &lt;&lt; std::endl;</span></div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>      <span class="comment">// std::cout &lt;&lt; &quot;Height: &quot; &lt;&lt; peaks.back()-&gt;height &lt;&lt; std::endl;</span></div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>      <span class="comment">// std::cout &lt;&lt; &quot;DQS: &quot; &lt;&lt; regression-&gt;dqs &lt;&lt; std::endl;</span></div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>    } <span class="comment">// end for loop</span></div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span> </div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>    <span class="keywordflow">return</span> peaks;</div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>  } <span class="comment">// end createPeaks</span></div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span><span class="preprocessor">#pragma endregion createPeaks</span></div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span> </div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span><span class="preprocessor">#pragma region calcMse</span></div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>  <span class="keywordtype">double</span> qPeaks::calcMse(<span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>, <span class="keyword">const</span> Matrix &amp;y)<span class="keyword"> const</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>    <span class="keywordtype">size_t</span> n = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.numel();</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> = 0.0;</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>    {</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) - <a class="code hl_variable" href="namespaceoptim__regr__window.html#a344ec29c4c5486272123bc51cf291982">y</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>      <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> += <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a>;</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>    }</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> / (n - 4);</div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>  } <span class="comment">// end calcMse</span></div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span> </div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>  <span class="keywordtype">double</span> qPeaks::calcMse(<span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>, <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>)<span class="keyword"> const</span></div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>    <span class="keywordtype">size_t</span> n = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.numel();</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> = 0.0;</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>    {</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>) - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>      <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> += <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a>;</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>    }</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> / (n - 4);</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>  } <span class="comment">// end calcMse</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span> </div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>  <span class="keywordtype">double</span> qPeaks::calcMseEXP(<span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>, <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>)<span class="keyword"> const</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>    <span class="keywordtype">size_t</span> n = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>.numel();</div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> = 0.0;</div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>    {</div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> = <a class="code hl_function" href="namespaceq.html#a441bff029a39aaf04dfa3ab8bb84bad9">exp_approx</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)) - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);</div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>      <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> += <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a>;</div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>    }</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> / (n - 4);</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>  } <span class="comment">// end calcMse</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span><span class="preprocessor">#pragma endregion calcMse</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span> </div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span><span class="preprocessor">#pragma region calcExtendedMse</span></div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>  <span class="keywordtype">void</span> qPeaks::calcExtendedMse(</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>      <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,                                               <span class="comment">// measured data (not log-transformed data)</span></div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>      <span class="keyword">const</span> std::vector&lt;std::unique_ptr&lt;validRegression&gt;&gt; &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>, <span class="comment">// regressions to compare</span></div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>      <span class="keyword">const</span> std::vector&lt;int *&gt; &amp;df)                                     <span class="comment">// degrees of freedom</span></div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>  {</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span><span class="comment">      The function consists of the following steps:</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span><span class="comment">      1. Identify left and right limit of the grouped regression windows.</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span><span class="comment">      2. Calculate yhat based on the coefficients matrix B and the extended design matrix X.</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span><span class="comment">      3. Calculate the mean squared error (MSE) between the predicted and actual values.</span></div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span><span class="comment">      4. Identify the best regression based on the MSE and return the MSE and the index of the best regression.</span></div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span><span class="comment">    */</span></div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>    <span class="comment">// declare variables</span></div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a> = std::numeric_limits&lt;double&gt;::infinity();</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>    <span class="keyword">auto</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_regression</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.begin();</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span> </div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>    <span class="comment">// step 1: identify left and right limit of the grouped regression windows</span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>    <span class="keywordtype">int</span> left_limit = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.front()-&gt;left_limit;</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>    <span class="keywordtype">int</span> right_limit = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.back()-&gt;right_limit;</div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span> </div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> regression = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.begin(); <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a> != <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.end(); ++<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>)</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>    {</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>      <span class="comment">// get the extended scale</span></div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> = std::max(</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>          (*regression)-&gt;index_x0 - left_limit, <span class="comment">// left limit</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>          right_limit - (*regression)-&gt;index_x0 <span class="comment">// right limit</span></div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>      );</div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span> </div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>      <span class="comment">// check if it is necessary to create new design matrices based on the extended scale</span></div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>      <span class="keywordflow">if</span> (designMatrices.size() &lt; (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - 1)) <span class="comment">// -1 because the design matrices are zero-based and start with scale 2</span></div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>      {</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span><span class="preprocessor">#pragma omp critical</span></div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>        {</div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>          <span class="comment">// scale is not available; create new design matrices from last available scale to the extended scale in steps of 1</span></div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a> = designMatrices.size() + 2; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> + 1; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a>++)</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>          {</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>            createDesignMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a>);</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>            createInverseAndPseudoInverse(*(designMatrices.back()));</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>          }</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>        }</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>      }</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span> </div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>      <span class="comment">// step 2: calculate yhat based on the coefficients matrix B and the extended design matrix X</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>      <span class="comment">// extract and cut the design matrix based on the extended scale</span></div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_0</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - (*regression)-&gt;index_x0 + left_limit;      <span class="comment">// start row index for cutting Design Matrix</span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_1</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - (*regression)-&gt;index_x0 + right_limit + 1; <span class="comment">// end row index for cutting Design Matrix</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span> </div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> = (*designMatrices[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - 2]).subMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_0</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_1</a>, 0, 4);</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>      <span class="comment">// calculate yhat based on the coefficients matrix B and the extended design matrix X</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> * (*regression)-&gt;B;</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span> </div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>      <span class="comment">// step 3: calculate the mean squared error (MSE) between the predicted and actual values</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>      <span class="keywordtype">double</span> mse = calcMseEXP(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.subMatrix(left_limit, right_limit + 1, 0, 1));</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>      <span class="comment">// correct the df for the mse calculation</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> = 0;</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = left_limit; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; right_limit + 1; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>      {</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> += *df[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>];</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>      }</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> &lt;= 4)</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>      {</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>        <span class="keywordflow">continue</span>; <span class="comment">// not enough degrees of freedom</span></div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>      }</div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>      mse *= (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.numRows() - 4) / (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 4);</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span> </div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>      <span class="comment">// step 4: identify the best regression based on the MSE and return the MSE and the index of the best regression</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>      <span class="keywordflow">if</span> (mse &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a>)</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>      {</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a> = mse;</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>        (*regression)-&gt;mse = mse;</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_regression</a> = <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>;</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>      }</div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>    } <span class="comment">// end for loop (index in groupIndices)</span></div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>    <span class="comment">// set isValid to false for all regressions except the best one</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> regression = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.begin(); <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a> != <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">regressions</a>.end(); ++<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>)</div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>    {</div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>      <span class="keywordflow">if</span> (regression != <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_regression</a>)</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>      {</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>        (*regression)-&gt;isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>      }</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>    }</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>  } <span class="comment">// end qPeaks::calcExtendedMse</span></div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span> </div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>  <span class="keywordtype">void</span> qPeaks::calcExtendedMse(</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>      <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>,                 <span class="comment">// measured data (not log-transformed data)</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>      validRegression &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">currentRegression</a>, <span class="comment">// current regression</span></div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>      validRegression &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">refRegression</a>,     <span class="comment">// reference regression</span></div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>      <span class="keyword">const</span> std::vector&lt;int *&gt; &amp;df        <span class="comment">// degrees of freedom</span></div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>  )</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>  {</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span><span class="comment">      The function consists of the following steps:</span></div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span><span class="comment">      1. Identify left and right limit of the grouped regression windows.</span></div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span><span class="comment">      2. Calculate yhat based on the coefficients matrix B and the extended design matrix X.</span></div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span><span class="comment">      3. Calculate the mean squared error (MSE) between the predicted and actual values.</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span><span class="comment">      4. Identify the best regression based on the MSE and return the MSE and the index of the best regression.</span></div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span><span class="comment">    */</span></div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>    <span class="comment">// declare variables</span></div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a> = std::numeric_limits&lt;double&gt;::infinity();</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_idx</a> = -1;</div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_extendedScale</a> = -1;</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_df</a> = 0;</div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_left_limit</a> = -1;</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_right_limit</a> = -1;</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_X_row_0</a> = -1;</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_X_row_1</a> = -1;</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>    <span class="comment">// step 1: identify left and right limit of the grouped regression windows</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>    <span class="keywordtype">int</span> left_limit = std::min(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">currentRegression</a>.left_limit, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">refRegression</a>.left_limit);</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>    <span class="keywordtype">int</span> right_limit = std::max(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">currentRegression</a>.right_limit, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">refRegression</a>.right_limit);</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">flag</a> = 0;</div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">stepInLoop</a> = 0;</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> regression : {&amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">currentRegression</a>, &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">refRegression</a>})</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>    {</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>      <span class="comment">// get the extended scale</span></div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> = std::max(</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>          <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0 - left_limit, <span class="comment">// left limit</span></div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>          right_limit - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0 <span class="comment">// right limit</span></div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>      );</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span> </div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>      <span class="comment">// check if it is necessary to create new design matrices based on the extended scale</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>      <span class="keywordflow">if</span> (designMatrices.size() &lt; (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - 1)) <span class="comment">// -1 because the design matrices are zero-based and start with scale 2</span></div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>      {</div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span><span class="preprocessor">#pragma omp critical</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>        {</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>          <span class="comment">// scale is not available; create new design matrices from last available scale to the extended scale in steps of 1</span></div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a> = designMatrices.size() + 2; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> + 1; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a>++)</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>          {</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>            createDesignMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">new_scale</a>);</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>            createInverseAndPseudoInverse(*(designMatrices.back()));</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>          }</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>        }</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>      }</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>      <span class="comment">// step 2: calculate yhat based on the coefficients matrix B and the extended design matrix X</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>      <span class="comment">// extract and cut the design matrix based on the extended scale</span></div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_0</a> = left_limit - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0 + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a>;      <span class="comment">// start row index for cutting Design Matrix</span></div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_1</a> = right_limit - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0 + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> + 1; <span class="comment">// end row index for cutting Design Matrix</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>      <span class="comment">// add an adjustment if there is a valleypoint between row_0 and row_1</span></div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">left_valley_adjust</a> = (<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(2, 0) &lt; 0)</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>                                   ? <span class="comment">// no valley point</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>                                   0</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>                                   : <span class="comment">// has a valley point</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>                                   std::<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">max</a>(</div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>                                       0,                                                                                          <span class="comment">// valley point is outside the window</span></div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>                                       (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">int</a>)(-<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) / 2 / <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(2, 0) + <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0 - left_limit)); <span class="comment">// valley point is inside the window</span></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">right_valley_adjust</a> = (<a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(3, 0) &lt; 0)</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>                                    ? <span class="comment">// no valley point</span></div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>                                    0</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>                                    : <span class="comment">// has a valley point</span></div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>                                    std::<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">max</a>(</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>                                        0,                                                                                          <span class="comment">// valley point is outside the window</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>                                        (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">int</a>)(right_limit + <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(1, 0) / 2 / <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B(3, 0) - <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;index_x0)); <span class="comment">// valley point is inside the window</span></div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> = (*designMatrices[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">extendedScale</a> - 2]).subMatrix(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_0</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">left_valley_adjust</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">row_1</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">right_valley_adjust</a>, 0, 4);</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>      <span class="comment">// calculate yhat based on the coefficients matrix B and the extended design matrix X</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>      Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a> * <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;B;</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span> </div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>      <span class="comment">// step 3: calculate the mean squared error (MSE) between the predicted and actual values</span></div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>      <span class="keywordtype">double</span> mse = calcMseEXP(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.subMatrix(left_limit + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">left_valley_adjust</a>, right_limit + 1 - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">right_valley_adjust</a>, 0, 1));</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>      <span class="comment">// correct the df for the mse calculation</span></div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>      <span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> = 0;</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = left_limit + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">left_valley_adjust</a>; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; right_limit + 1 - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">right_valley_adjust</a>; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>      {</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> += *df[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>];</div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>      }</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span> </div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> &lt;= 4)</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>      {</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>        <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">stepInLoop</a>++;</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>        <span class="keywordflow">continue</span>; <span class="comment">// not enough degrees of freedom</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>      }</div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span> </div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>      mse *= (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat</a>.numRows() - 4) / (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">df_sum</a> - 4);</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>      <span class="comment">// step 4: identify the best regression based on the MSE and return the MSE and the index of the best regression</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>      <span class="keywordflow">if</span> (mse &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a>)</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>      {</div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">best_mse</a> = mse;</div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">flag</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">stepInLoop</a>;</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">stepInLoop</a>++;</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>      }</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>      {</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>        <a class="code hl_function" href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">regression</a>-&gt;isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">stepInLoop</a>++;</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>      }</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>    } <span class="comment">// end for loop</span></div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>    <span class="comment">// set worse regression to invalid</span></div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">flag</a> == 0)</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>    { <span class="comment">// current regression is better than ref regression</span></div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">refRegression</a>.isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>    }</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>    { <span class="comment">// ref regression is better than current regression</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">currentRegression</a>.isValid = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>    }</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>  }</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span><span class="preprocessor">#pragma endregion calcExtendedMse</span></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span> </div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span><span class="preprocessor">#pragma region calcChiSquareEXP</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>  <span class="keywordtype">double</span> qPeaks::calcChiSquareEXP(<span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>, <span class="keyword">const</span> RefMatrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>)<span class="keyword"> const</span></div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>    <span class="keywordtype">size_t</span> n = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>.numel();</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> = 0.0;</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; ++<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>)</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>    {</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_exp</a> = <a class="code hl_function" href="namespaceq.html#a441bff029a39aaf04dfa3ab8bb84bad9">exp_approx</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_log</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>));</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>      <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_exp</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Y</a>.getElement(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>      <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> += <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">diff</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">yhat_exp</a>;</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>    }</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a>;</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>  } <span class="comment">// end calcChiSquareEXP</span></div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span><span class="preprocessor">#pragma endregion calcChiSquareEXP</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span> </div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span><span class="preprocessor">#pragma region jacobianMatrix_PeakArea</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>  std::pair&lt;Matrix, Matrix&gt; qPeaks::jacobianMatrix_PeakArea(<span class="keyword">const</span> Matrix &amp;B, <span class="keywordtype">int</span> scale)<span class="keyword"> const</span></div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>    <span class="comment">// predefine expressions</span></div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b0</a> = B(0, 0);</div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> = B(1, 0);</div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> = B(2, 0);</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> = B(3, 0);</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a> = std::sqrt(std::abs(-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a>));</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a> = std::sqrt(std::abs(-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a>));</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B0</a> = std::exp(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b0</a>);</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a>;</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B12</a> = std::exp(-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> / 2);</div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a>;</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B13</a> = std::exp(-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> / 2);</div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span> </div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>    <span class="comment">// initialize variables</span></div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>(1, 4);         <span class="comment">// Jacobian matrix</span></div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>(1, 4); <span class="comment">// Jacobian matrix for the covered peak area</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> = -<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>; <span class="comment">// left limit due to the window</span></div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> = <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>; <span class="comment">// right limit due to the window</span></div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_left</a> = 0;      <span class="comment">// y value at the left limit</span></div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>    <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_right</a> = 0;     <span class="comment">// y value at the right limit</span></div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span> </div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>    <span class="comment">// here we have to check if there is a valley point or not</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L</a> =</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>        (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> &lt; 0)</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>            ? 1 - std::erf(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a>) <span class="comment">// ordinary peak</span></div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>            : <a class="code hl_function" href="namespaceq.html#af5bc719469eba45978bfaa23379f329b">erfi</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a>);        <span class="comment">// peak with valley point;</span></div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span> </div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R</a> =</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>        (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> &lt; 0)</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>            ? 1 + std::erf(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a>) <span class="comment">// ordinary peak</span></div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>            : -<a class="code hl_function" href="namespaceq.html#af5bc719469eba45978bfaa23379f329b">erfi</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a>);       <span class="comment">// peak with valley point ;</span></div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span> </div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L_covered</a> = </div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>        (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> &lt; 0)</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>            ? <span class="comment">// ordinary peak half, take always scale as integration limit; we use erf instead of erfi due to the sqrt of absoulte value</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>            std::erf((<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> - 2 * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> * scale) / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a>) + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L</a> - 1</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>            : <span class="comment">// valley point, i.e., check position</span></div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>            (-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> &lt; -<a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>)</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>                ? <span class="comment">// valley point is outside the window, use scale as limit</span></div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>                <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L</a> - <a class="code hl_function" href="namespaceq.html#af5bc719469eba45978bfaa23379f329b">erfi</a>((<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> - 2 * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>) / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a>)</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>                : <span class="comment">// valley point is inside the window, use valley point as limit</span></div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>                <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L</a>;</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span> </div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R_covered</a> = </div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>        (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> &lt; 0)</div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>            ? <span class="comment">// ordinary peak half, take always scale as integration limit; we use erf instead of erfi due to the sqrt of absoulte value</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>            <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R</a> - 1 - std::erf((<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> + 2 * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> * scale) / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a>)</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>            : <span class="comment">// valley point, i.e., check position</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>            (-<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> &gt; <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>)</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>                ? <span class="comment">// valley point is outside the window, use scale as limit</span></div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>                <a class="code hl_function" href="namespaceq.html#af5bc719469eba45978bfaa23379f329b">erfi</a>((<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> + 2 * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>) / 2 / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a>) + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R</a></div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>                : <span class="comment">// valley point is inside the window, use valley point as limit</span></div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>                <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R</a>;</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span> </div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span>    <span class="comment">// adjust x limits</span></div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> &gt; 0 &amp;&amp; -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> &gt; -scale)</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>    { <span class="comment">// valley point is inside the window, use valley point as limit</span></div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a>;</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>    }</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span> </div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> &gt; 0 &amp;&amp; -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> &lt; scale)</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>    { <span class="comment">// valley point is inside the window, use valley point as limit</span></div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>      <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a>;</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>    }</div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span> </div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>    <span class="comment">// calculate the y values at the left and right limits</span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_left</a> = std::exp(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b0</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b2</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a>);</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_right</a> = std::exp(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b0</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b3</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a>);</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dX</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a>;</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span> </div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>    <span class="comment">// calculate the trapzoid correction terms for the jacobian matrix</span></div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b0</a> = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_right</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_left</a>) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dX</a> / 2;</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b1</a> = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_right</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_left</a>) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dX</a> / 2;</div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b2</a> = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_left</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_left</a>) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dX</a> / 2;</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b3</a> = (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">x_right</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">y_right</a>) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">dX</a> / 2;</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span> </div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>    <span class="comment">// calculate the Jacobian matrix terms</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_L</a> = <a class="code hl_variable" href="namespaceq.html#a7802e44edc2837261a1040659ae95d8a">SQRTPI_2</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B0</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B12</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB2</a>;</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_R</a> = <a class="code hl_variable" href="namespaceq.html#a7802e44edc2837261a1040659ae95d8a">SQRTPI_2</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B0</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B13</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">SQRTB3</a>;</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_L</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B0</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>;</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_R</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">EXP_B0</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>;</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span> </div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_L</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L</a>;</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L_covered</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_L</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_L_covered</a>;</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_R</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R</a>;</div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R_covered</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_common_R</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">err_R_covered</a>;</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span> </div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_L</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a>;</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L_covered</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_L</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L_covered</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a>;</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R</a> = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_R</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a>;</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R_covered</a> = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_common_R</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R_covered</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a>;</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span> </div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>(0, 0) = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L</a>;</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>(0, 1) = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L</a>;</div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>(0, 2) = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> * (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>);</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>(0, 3) = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> * (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>);</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span> </div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>(0, 0) = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R_covered</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L_covered</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b0</a>;</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>(0, 1) = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R_covered</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L_covered</a> - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b1</a>;</div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>(0, 2) = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B2</a> * (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_L_covered</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_L_covered</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>) - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b2</a>;</div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>    <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>(0, 3) = -<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">B1_2_B3</a> * (<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_2_R_covered</a> + <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_1_R_covered</a> / <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">b1</a>) - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">trpzd_b3</a>;</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span> </div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>    <span class="keywordflow">return</span> std::pair&lt;Matrix, Matrix&gt;(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">J_covered</a>);</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>  } <span class="comment">// end jacobianMatrix_PeakArea</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span><span class="preprocessor">#pragma endregion jacobianMatrix_PeakArea</span></div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span> </div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span><span class="preprocessor">#pragma region createDesignMatrix</span></div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>  <span class="keywordtype">void</span> qPeaks::createDesignMatrix(<span class="keyword">const</span> <span class="keywordtype">int</span> scale)</div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>  {</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>    <span class="comment">// construct matrix</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>    <span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">m</a> = 4;</div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>    <span class="keywordtype">size_t</span> n = 2 * <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a> + 1;</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>(n, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">m</a>);</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span> </div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>    <span class="comment">// x vector</span></div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>    std::vector&lt;int&gt; <a class="code hl_variable" href="namespaceoptim__regr__window.html#a9aee448d8f1720c8cfbe0c6c7158da4f">x</a>(n);</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>    {</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>      <a class="code hl_variable" href="namespaceoptim__regr__window.html#a9aee448d8f1720c8cfbe0c6c7158da4f">x</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>] = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> - <a class="code hl_variable" href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">scale</a>;</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>    }</div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span> </div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span>    <span class="comment">// order vector</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>    std::vector&lt;int&gt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">p</a> = {0, 1, 2, 2};</div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span> </div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>    {</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">j</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">j</a> &lt; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">m</a>; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">j</a>++)</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>      {</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">j</a>) = std::pow(x[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>], <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">p</a>[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">j</a>]);</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span>      }</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>    }</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span> </div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>    <span class="comment">// modification of X due to p(2) and p(3)</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 0; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt; n; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>++)</div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>    {</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>      <span class="keywordflow">if</span> (x[<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>] &lt; 0)</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>      {</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, 3) = 0;</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>      }</div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>      {</div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>        <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>, 2) = 0;</div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>      }</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>    }</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span> </div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>    <span class="comment">// add the matrix to the designMatrices vector</span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>    designMatrices.push_back(std::make_unique&lt;Matrix&gt;(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>));</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>  }</div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span><span class="preprocessor">#pragma endregion createDesignMatrix</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span> </div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span><span class="preprocessor">#pragma region createInverseAndPseudoInverse</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span>  <span class="keywordtype">void</span> qPeaks::createInverseAndPseudoInverse(<span class="keyword">const</span> Matrix &amp;<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>)</div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>  {</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Xt</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>.T();</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>    Matrix <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">XtX</a> = <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Xt</a> * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">X</a>;</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>    inverseMatrices.push_back(std::make_unique&lt;Matrix&gt;(<a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">XtX</a>.inv()));</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>    psuedoInverses.push_back(std::make_unique&lt;Matrix&gt;(*(inverseMatrices.back()) * <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">Xt</a>));</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>  }</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span> </div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>  <span class="keywordtype">int</span> qPeaks::calculateNumberOfRegressions(<span class="keyword">const</span> <span class="keywordtype">int</span> n)<span class="keyword"> const</span></div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>    <span class="comment">/*</span></div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span><span class="comment">    int maxScale = (int) (n - 1) / 2;</span></div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span><span class="comment">    int sumScales = (int) (maxScale * (maxScale + 1) / 2) - 1;</span></div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span><span class="comment">    return n * (maxScale-1) - sumScales*2;</span></div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span><span class="comment">    */</span></div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>    <span class="keywordtype">int</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> = 0;</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> = 4; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> &lt;= this-&gt;global_maxScale * 2; <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a> += 2)</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>    {</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>      <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a> += std::max(0, n - <a class="code hl_function" href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">i</a>);</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>    }</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">sum</a>;</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>  }</div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="preprocessor">#pragma endregion createInverseAndPseudoInverse</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span> </div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span><span class="preprocessor">#pragma region info</span></div>
<div class="foldopen" id="foldopen00996" data-start="{" data-end="}">
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#afa5891d8281a1d12003c307a08c6a2c0">  996</a></span>  <span class="keywordtype">void</span> <a class="code hl_function" href="classq_1_1q_peaks.html#afa5891d8281a1d12003c307a08c6a2c0">qPeaks::info</a>()<span class="keyword"> const</span></div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;qPeaks object\n&quot;</span>;</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;designMatrices size: &quot;</span> &lt;&lt; designMatrices.size() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;inverseMatrices size: &quot;</span> &lt;&lt; inverseMatrices.size() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;psuedoInverses size: &quot;</span> &lt;&lt; psuedoInverses.size() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>  }</div>
</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span><span class="preprocessor">#pragma endregion info</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span> </div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span><span class="preprocessor">#pragma region printMatrices</span></div>
<div class="foldopen" id="foldopen01006" data-start="{" data-end="}">
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"><a class="line" href="classq_1_1q_peaks.html#a6ea06a52051f8ab0776f9949fd811179"> 1006</a></span>  <span class="keywordtype">void</span> <a class="code hl_function" href="classq_1_1q_peaks.html#a6ea06a52051f8ab0776f9949fd811179">qPeaks::printMatrices</a>(<span class="keywordtype">int</span> scale)<span class="keyword"> const</span></div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span><span class="keyword">  </span>{</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;Design Matrix\n&quot;</span>;</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>    designMatrices[scale - 2]-&gt;print();</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;Inverse Matrix\n&quot;</span>;</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>    inverseMatrices[scale - 2]-&gt;print();</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;Pseudo-Inverse Matrix\n&quot;</span>;</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span>    psuedoInverses[scale - 2]-&gt;print();</div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>  }</div>
</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span><span class="preprocessor">#pragma endregion printMatrices</span></div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span><span class="preprocessor">#pragma endregion Methods</span></div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>} <span class="comment">// namespace q</span></div>
<div class="ttc" id="aclassq_1_1_matrix_html"><div class="ttname"><a href="classq_1_1_matrix.html">q::Matrix</a></div><div class="ttdoc">A class to store a matrix.</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__matrix_8h_source.html#l00025">qalgorithms_matrix.h:26</a></div></div>
<div class="ttc" id="aclassq_1_1_matrix_html_a34a6a5e87cf0b5a9eb832caaec1b9ab4"><div class="ttname"><a href="classq_1_1_matrix.html#a34a6a5e87cf0b5a9eb832caaec1b9ab4">q::Matrix::log</a></div><div class="ttdeci">Matrix log() const</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__matrix_8cpp_source.html#l00270">qalgorithms_matrix.cpp:270</a></div></div>
<div class="ttc" id="aclassq_1_1_matrix_html_aceb7f09f0eea5817c7e46d7cdbb7870d"><div class="ttname"><a href="classq_1_1_matrix.html#aceb7f09f0eea5817c7e46d7cdbb7870d">q::Matrix::convoleCombiend</a></div><div class="ttdeci">Matrix convoleCombiend(const Matrix &amp;kernel) const</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__matrix_8cpp_source.html#l00476">qalgorithms_matrix.cpp:476</a></div></div>
<div class="ttc" id="aclassq_1_1_ref_matrix_html"><div class="ttname"><a href="classq_1_1_ref_matrix.html">q::RefMatrix</a></div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__refmatrix_8h_source.html#l00014">qalgorithms_refmatrix.h:15</a></div></div>
<div class="ttc" id="aclassq_1_1q_peaks_html_a401e618cceed5b32fae8b6e9e5e57005"><div class="ttname"><a href="classq_1_1q_peaks.html#a401e618cceed5b32fae8b6e9e5e57005">q::qPeaks::qPeaks</a></div><div class="ttdeci">qPeaks()</div><div class="ttdef"><b>Definition</b> <a href="#l00012">qalgorithms_qpeaks.cpp:12</a></div></div>
<div class="ttc" id="aclassq_1_1q_peaks_html_a6ea06a52051f8ab0776f9949fd811179"><div class="ttname"><a href="classq_1_1q_peaks.html#a6ea06a52051f8ab0776f9949fd811179">q::qPeaks::printMatrices</a></div><div class="ttdeci">void printMatrices(int scale) const</div><div class="ttdef"><b>Definition</b> <a href="#l01006">qalgorithms_qpeaks.cpp:1006</a></div></div>
<div class="ttc" id="aclassq_1_1q_peaks_html_a6fe1f39896e39558ac88cbeb7fab5a6c"><div class="ttname"><a href="classq_1_1q_peaks.html#a6fe1f39896e39558ac88cbeb7fab5a6c">q::qPeaks::~qPeaks</a></div><div class="ttdeci">~qPeaks()</div><div class="ttdef"><b>Definition</b> <a href="#l00052">qalgorithms_qpeaks.cpp:52</a></div></div>
<div class="ttc" id="aclassq_1_1q_peaks_html_a84e1e2fe8b7b0434b682b28803297477"><div class="ttname"><a href="classq_1_1q_peaks.html#a84e1e2fe8b7b0434b682b28803297477">q::qPeaks::findPeaks</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; std::unique_ptr&lt; DataType::Peak &gt; &gt; &gt; findPeaks(const varDataType &amp;dataVec)</div><div class="ttdoc">Find the peaks in the data. Container function to call the findPeaks method.</div><div class="ttdef"><b>Definition</b> <a href="#l00057">qalgorithms_qpeaks.cpp:57</a></div></div>
<div class="ttc" id="aclassq_1_1q_peaks_html_afa5891d8281a1d12003c307a08c6a2c0"><div class="ttname"><a href="classq_1_1q_peaks.html#afa5891d8281a1d12003c307a08c6a2c0">q::qPeaks::info</a></div><div class="ttdeci">void info() const</div><div class="ttdef"><b>Definition</b> <a href="#l00996">qalgorithms_qpeaks.cpp:996</a></div></div>
<div class="ttc" id="anamespaceoptim__regr__window_html_a344ec29c4c5486272123bc51cf291982"><div class="ttname"><a href="namespaceoptim__regr__window.html#a344ec29c4c5486272123bc51cf291982">optim_regr_window.y</a></div><div class="ttdeci">int y</div><div class="ttdef"><b>Definition</b> <a href="optim__regr__window_8py_source.html#l00048">optim_regr_window.py:48</a></div></div>
<div class="ttc" id="anamespaceoptim__regr__window_html_a9aee448d8f1720c8cfbe0c6c7158da4f"><div class="ttname"><a href="namespaceoptim__regr__window.html#a9aee448d8f1720c8cfbe0c6c7158da4f">optim_regr_window.x</a></div><div class="ttdeci">x</div><div class="ttdef"><b>Definition</b> <a href="optim__regr__window_8py_source.html#l00047">optim_regr_window.py:47</a></div></div>
<div class="ttc" id="anamespaceoptim__regr__window_html_ad2ceac8162180012a3008f7cb6fa645c"><div class="ttname"><a href="namespaceoptim__regr__window.html#ad2ceac8162180012a3008f7cb6fa645c">optim_regr_window.regression</a></div><div class="ttdeci">regression(scale, y)</div><div class="ttdef"><b>Definition</b> <a href="optim__regr__window_8py_source.html#l00008">optim_regr_window.py:8</a></div></div>
<div class="ttc" id="anamespaceoptim__regr__window_html_af4a20dbdda11cbc8e0c21c7f721e744c"><div class="ttname"><a href="namespaceoptim__regr__window.html#af4a20dbdda11cbc8e0c21c7f721e744c">optim_regr_window.scale</a></div><div class="ttdeci">int scale</div><div class="ttdoc">add the peak position</div><div class="ttdef"><b>Definition</b> <a href="optim__regr__window_8py_source.html#l00046">optim_regr_window.py:46</a></div></div>
<div class="ttc" id="anamespaceq_html"><div class="ttname"><a href="namespaceq.html">q</a></div><div class="ttdef"><b>Definition</b> <a href="qalgorithms_8h_source.html#l00020">qalgorithms.h:21</a></div></div>
<div class="ttc" id="anamespaceq_html_a1ec04afafe30778c469db879d2b596ff"><div class="ttname"><a href="namespaceq.html#a1ec04afafe30778c469db879d2b596ff">q::tValuesArray</a></div><div class="ttdeci">const double tValuesArray[500]</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00122">qalgorithms_utils.cpp:122</a></div></div>
<div class="ttc" id="anamespaceq_html_a441bff029a39aaf04dfa3ab8bb84bad9"><div class="ttname"><a href="namespaceq.html#a441bff029a39aaf04dfa3ab8bb84bad9">q::exp_approx</a></div><div class="ttdeci">double exp_approx(const double x)</div><div class="ttdoc">Fast exponential approximation base on Bit Manipulation.</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00030">qalgorithms_utils.cpp:30</a></div></div>
<div class="ttc" id="anamespaceq_html_a4dea617c66f5c5dfc66e60e2e128f5da"><div class="ttname"><a href="namespaceq.html#a4dea617c66f5c5dfc66e60e2e128f5da">q::varDataType</a></div><div class="ttdeci">std::variant&lt; MS &gt; varDataType</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__measurement__data_8h_source.html#l00018">qalgorithms_measurement_data.h:18</a></div></div>
<div class="ttc" id="anamespaceq_html_a5ea2b3dedfaa98557b94135396085f23"><div class="ttname"><a href="namespaceq.html#a5ea2b3dedfaa98557b94135396085f23">q::sum</a></div><div class="ttdeci">int sum(const std::vector&lt; int &gt; &amp;vec)</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00006">qalgorithms_utils.cpp:6</a></div></div>
<div class="ttc" id="anamespaceq_html_a7802e44edc2837261a1040659ae95d8a"><div class="ttname"><a href="namespaceq.html#a7802e44edc2837261a1040659ae95d8a">q::SQRTPI_2</a></div><div class="ttdeci">const double SQRTPI_2</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00126">qalgorithms_utils.cpp:126</a></div></div>
<div class="ttc" id="anamespaceq_html_a84ad6a8042d2bf8703d3b1291b97953a"><div class="ttname"><a href="namespaceq.html#a84ad6a8042d2bf8703d3b1291b97953a">q::chiSquareArray</a></div><div class="ttdeci">const double chiSquareArray[500]</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00124">qalgorithms_utils.cpp:124</a></div></div>
<div class="ttc" id="anamespaceq_html_af5bc719469eba45978bfaa23379f329b"><div class="ttname"><a href="namespaceq.html#af5bc719469eba45978bfaa23379f329b">q::erfi</a></div><div class="ttdeci">double erfi(const double x)</div><div class="ttdef"><b>Definition</b> <a href="qalgorithms__utils_8cpp_source.html#l00102">qalgorithms_utils.cpp:102</a></div></div>
<div class="ttc" id="apugixml_8cpp_html_a26cc6d62586f67dca2d7b25184156168"><div class="ttname"><a href="pugixml_8cpp.html#a26cc6d62586f67dca2d7b25184156168">string_to_integer</a></div><div class="ttdeci">PUGI_IMPL_FN PUGI_IMPL_UNSIGNED_OVERFLOW U string_to_integer(const char_t *value, U minv, U maxv)</div><div class="ttdef"><b>Definition</b> <a href="pugixml_8cpp_source.html#l04547">pugixml.cpp:4547</a></div></div>
<div class="ttc" id="aqalgorithms__qpeaks_8h_html"><div class="ttname"><a href="qalgorithms__qpeaks_8h.html">qalgorithms_qpeaks.h</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
