---
title: "Analysis qbinning"
author: "Daniel Höhn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
library(TeachingDemos)
library(pracma)

makeDQS <- function(MID, MOD){
  dqs = (MOD - MID) * (1 / (1 + MID)) / max(MID, MOD)
  dqs = (dqs + 1) / 2
  return(dqs)
}
critVal <- function(n){
  ## Function generating the critical mz difference using order statistics
  
  critVal <- 3.05037165842070*log(n)^(-0.4771864667153)
  return(critVal)
}
```

```{r new bin}
monobin = read.csv("../../rawdata/monobin_base.csv")
monobin = monobin[which(1912 < monobin$scans & monobin$scans < 1958),]

# erstelle je 1 Eintrag für alle scans zwischen 1913 und 1957
for (i in 1913:1957) {
  r = runif(1, 2, 4)
  a = c(55*r, r*r/1000000, runif(1, 700, 2000), i, 1, -1, 0, -1)
  monobin = rbind(monobin, a)
}
for (i in 1:length(monobin$mz)) {
  t1 = c(monobin$mz[i]*runif(1, 2, 3), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  t2 = c(monobin$mz[i]*runif(1, 2, 4), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  monobin = rbind(monobin, t1)
  monobin = rbind(monobin, t2)
}
monobin$rt = monobin$scans * 0.65
monobin = monobin[with(monobin, order(scans, mz)), ]

# write.csv(monobin, "../../rawdata/monobin.csv", row.names = FALSE)

# für R:
monoR = read.csv("../../rawdata/monobin.csv")[,-8]
write.csv(monoR, "../../rawdata/monobinForR.csv", row.names = FALSE)

```

```{r artificial bin}
artmz = rep(c(200,300,400), each = 10)
artmz = artmz + runif(30, 0.0001, 0.0009)
arterror = artmz * 0.000005
artscan = c(1:10, 6:15, 11:20)

artbin = data.frame(mz = artmz, error = arterror, rt = NA, scans = artscan, intensity = 1, ID = c(rep(1:3, each = 10)), DQScen = 0.99, DQSbin = 0.99)

out1 = c(215, 0.001, NA, 2, 1, 0, 0.1, 0.1)
out2 = c(300.5, 0.0015, NA, 20, 1, 0, 0.1, 0.1)

artbin = rbind(artbin, out1, out2)
artbin$rt = 0.65 * artbin$scans + 1

# write.csv(artbin, "../../rawdata/artbin.csv", row.names = FALSE)
```

```{r timings}
# all times in nanoseconds

subsetMZ_r = c(2532043400, 519514200, 63991800, 4207800, 318200, 44400)
subsetScan_r = c(451073000, 345650500, 32338100, 2404200, 182500, 15000)

sum(subsetMZ_r) * 10^-9
sum(subsetScan_r) * 10^-9


subsetMZ_i = c(1058070300, 208686400, 25039300, 1755800, 144200, 9500)
subsetScan_i = c(186643200, 148777100, 14468300, 936100, 49800, 5400)

sum(subsetMZ_i) * 10^-9
sum(subsetScan_i) * 10^-9
```

```{r merge}
prebinned <- read.csv("../../rawdata/control_bins_base.csv")
rawdata <- read.csv("../../rawdata/qCentroid_Warburg_pos_171123_01_Zu_01.csv")
prebinned$mzError <- rawdata$Centroid.Error
#mz column, centroid error column, RT column, scan number column, control ID column 
export <- data.frame(mz = prebinned$mz, mzError = prebinned$mzError, RT = prebinned$rt, scanNo = prebinned$scanNo, intensity = prebinned$intensity, controlID = prebinned$ID, controlCentroidDQS = prebinned$DQScen, controlBinDQS = prebinned$DQSbin)

write.csv(export, "../../rawdata/control_bins_full.csv", row.names = FALSE)
getwd()
```

```{r check bin summary}
summary_norm <- read.csv("../../selectBins_summary_norm.csv")
summary_redo <- read.csv("../../selectBins_summary_redo.csv")
redoneBins <- read.csv("../../redoneBins_summary.csv")
# re-binning reduced bad binning by 355 bins 
sum(summary_redo$mean_mz %in% summary_norm$mean_mz) # 4048
sum(summary_redo$DQSC_min %in% summary_norm$DQSC_min) # 4332
# 4048 bins remain unchanged, while 284 were expanded but still have bad neighbours
selector = !(redoneBins$mean_mz %in% summary_redo$mean_mz)
newGoodBins = redoneBins[selector,] # 1458 new error(only 2 and 3)-free bins with mean DQSB of 0.82; generally even distribution in mz/scans, average size of 14


```

```{r error analysis}
points_total = 3568033
bins_total = 55910
notbinned_total = 1102746

summary <- read.csv("../../selectbins_summary.csv")
# summary$errorcode[which(summary$errorcode == 128)] = 0
bins <- read.csv("../../selectbins_full.csv")
# notbinned = read.csv("../../qbinning_notbinned.csv")
summary$errorcode = as.numeric(lapply(summary$errorcode, bits))

summary = summary[order(summary$size, decreasing = TRUE),]

summary %>% group_by(errorcode) %>% summarise(bin_count = n(), total_points = sum(size), ratio = sum(size)/n(), dqsCen = mean(DQSC_min)) 

stats = as.data.frame(table(summary$errorcode)) # alle ungeraden Zahlen haben duplikate
stats$Var1 = as.numeric(levels(stats$Var1))

stats[stats$Var1 %% 2 != 0,]
 
stats[stats$Var1 - round(stats$Var1, -2) >= 10,] # Seltsame DQS korrelierern nicht mit anderen Fehlern

# MZ außerhalb 3 sigma korreliert mit 
stats[stats$Var1 >= 10000,]


subsample_notbinned = round(runif(5000, 1, notbinned_total))

ggplot(summary[summary$errorcode - round(summary$errorcode, -5) >= 1000,])+
  geom_point(data = notbinned[subsample_notbinned,], aes(x = mz, y = scan)) +
  geom_point(aes(x = mean_mz, y = mean_scans, colour = as.factor(errorcode)))
  # scale_color_viridis()

ggplot(summary[summary$errorcode - round(summary$errorcode, -3) >= 100,])+
  geom_point(data = notbinned[subsample_notbinned,], aes(x = mz, y = scan)) +
  geom_point(aes(x = mean_mz, y = mean_scans, colour = as.factor(errorcode)))



bins_error[bins_error$ID == 308,]
minDists308 = c(6.2961233993519272e-05, 8.8906114996234464e-05, 9.4137318995990427e-05, 0.0001178799969920874, 8.2152471009067085e-05, 7.1812920992897489e-05)
errors308 = c(2.62158179102052e-05, 0.000221785977937405, 1.7943534787886702e-05, 3.6100375305253397e-05, 1.8813454471750598e-05, 7.20372773346827e-05)
MIDs308 = fast_mean_distance(bins_error[bins_error$ID == 308,1])
maxdist308 = critVal(6) * mean(errors308)
maxdist308_7 = critVal(7) * mean(errors308)

for (i in 1:6) {
  print(sprintf("%0.10f /// %0.10f", makeDQS(MIDs308[i], minDists308[i]), makeDQS(MIDs308[i], maxdist308)))
}

length(bins_error$mz)/points_total
length(bins_error$mz)/(points_total - notbinned_total)
mean(summary$size)
(points_total - notbinned_total)/(bins_total - length(summary$size))

subset_step = c(0, 4205, 46173, 54939, 55836, 55904, 55910)
error_perc = data.frame(step = 0:6, perc_sum = 0, perc_all = 0)
for (i in 2:7) {
  sum_match = sum((subset_step[i-1] < summary$ID) & summary$ID < subset_step[i])
  error_perc$perc_sum[i] = sum_match/7508
  error_perc$perc_all[i] = (subset_step[i] - subset_step[i-1])/bins_total
}
# markierte bins sind nicht in einem der Schritte deutlich wahrscheinlicher als alle anderen
```

```{r binviewer and rater}

last_viewed_bin = 646

binRater(summary,bins,last_viewed_bin)

summary$manual[83]
binRater = function(summary, fullbins, startNo){
  cat("Rate bins using numbers:
        0: The bin is good as-is (Peak extraction might be good)
        1: Some noise reduction is needed / slanted peak profile
        2: few extreme intensities
        3: Two or more possible peaks are connected by noise data
        4: There is no obvious peak visible here
        5: Strong asymmetry in mz/scans
        6: 
        7: 
        8: 
        9: 
      Enter # to stop rating bins. The bin index you stopped at will be printed to the console. Your selections are saved to the dataframe \"summary\".\n")
  readline("Press Enter to start the bin rating process.")
  i = startNo
  rateNext = T
  while (rateNext) {
    binID = summary$ID[i]
    print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(mz, scan, color = intensity))+ # , color = as.factor(ID)
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[1]))
    )
    rating = readline("Rating:   ")
    if(rating == "#"){
      rateNext = F
    }else{
      summary$manual[i] = rating
      i = i+1
    }
    
  }
  
  assign("summary", summary, envir = .GlobalEnv)
  sprintf("Set startNo to %d to continue rating.", i)
}



# ggplot(bins_error[which(bins_error$ID == 39242 | bins_error$ID == 39243),])+
ggplot(bins_error[which(bins_error$ID == 12885),])+
  geom_point(aes(mz, scan, color = as.factor(ID)))

min(bins_error$mz[which(bins_error$ID == 39243)]) - max(bins_error$mz[which(bins_error$ID == 39242)])


critVal(6) * summary$meanError[which(summary$ID == 39242)]
critVal(5) * summary$meanError[which(summary$ID == 39243)]


ggplot(bins[which(bins$ID == 22),])+
  geom_point(aes(mz, scan, color = intensity))+ # , color = as.factor(ID)
  xlab("m/z")+
  ylab("Scan Number")+
  theme(panel.background = element_rect(fill = "lightblue1",
                                colour = "lightblue1",
                                linewidth = 0.5, linetype = "solid"))+
  scale_color_viridis_c(option = "plasma", direction = -1)+
  labs(caption = sprintf("Errorcode: %d", summary$errorcode[22]))
  
  
```

