---
title: "Analysis qbinning"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
library(TeachingDemos)
library(pracma)

makeDQS <- function(MID, MOD){
  dqs = (MOD - MID) * (1 / (1 + MID)) / max(MID, MOD)
  dqs = (dqs + 1) / 2
  return(dqs)
}
critVal <- function(n){
  ## Function generating the critical mz difference using order statistics
  
  critVal <- 3.05037165842070*log(n)^(-0.4771864667153)
  return(critVal)
}
```

```{r check bin summary}
summary <- read.csv("../../results/warburg_summary.csv")
bins <- read.csv("../../results/warburg_bins.csv")

summary = read.csv("C:/Users/unisys/Documents/Studium/Messdaten/warburg_summary.csv")
bins = read.csv("C:/Users/unisys/Documents/Studium/Messdaten/warburg_bins.csv")
summary$errorcode = as.numeric(lapply(summary$errorcode, bits))

```

```{r error analysis}
points_total = 3568033
bins_total = 55910
notbinned_total = 1102746

# summary <- read.csv("C:/Users/unisys/Documents/Studium/Analytik-Praktikum/rawdata/warburg_summary.csv")
summary <- read.csv("G:/_Studium/Analytik-Praktikum/qbinning/results/warburg_summary.csv")
summary$errorcode = as.numeric(lapply(summary$errorcode, bits))
bins <- read.csv("G:/_Studium/Analytik-Praktikum/qbinning/results/warburg_bins.csv")


# "../../selectbins_summary.csv"
# bins <- read.csv("../../selectbins_full.csv")
# notbinned = read.csv("../../qbinning_notbinned.csv")
# summary$errorcode = summary$errorcode - 10000000

summary = summary[order(summary$size, decreasing = TRUE),]

summary %>% group_by(errorcode) %>% summarise(bins = n(), centroids = sum(size), ratio = round(sum(size)/n(),digits = 3), dqsCen = mean(DQSC_min), meanDQS = mean(DQSB_scaled)) 

stats = as.data.frame(table(summary$errorcode)) # alle ungeraden Zahlen haben duplikate
stats$Var1 = as.numeric(levels(stats$Var1))

# selectIDs = summary$ID[which(summary$errorcode == 10000)]
# for (i in selectIDs) {
#   binViewer(summary,bins,i)
# }

# ggplot(summary)+
#   geom_point(aes(median_mz, mean_scans, color = as.factor(errorcode)))+
#   theme(legend.position="none")
# binSelectionViewer(summary,bins,summary$ID[which(summary$errorcode == 0)])
```

```{r binviewer and rater}
# last_viewed_bin = 646
# 
# binRater(summary,bins,last_viewed_bin)
# 
# # summary$manual[83]

binViewer = function(summary, fullbins, binID){
 
  readline("Press Enter to continue.")
  rateNext = T
  while (rateNext) {
    ppm5 = summary$mean_mz[which(summary$ID == binID)] * 5 * 10^-6
    meanMZ = summary$mean_mz[which(summary$ID == binID)]
    stdev = summary$stdev_mz[which(summary$ID == binID)]
    print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(mz, scan, color = intensity))+ 
      geom_vline(xintercept = meanMZ - ppm5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = meanMZ + ppm5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = meanMZ - stdev, linewidth = 0.2, linetype = "dashed", color = "red")+
      geom_vline(xintercept = meanMZ + stdev, linewidth = 0.2, linetype = "dashed", color = "red")+  
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID]))
    )
    input = readline()
    if(input == "#"){
      rateNext = F
    } else if(input == ""){
      binID = binID + 1
    } else if(input == "<") {
      binID = binID - 1
    } else if(input == "p"){
      print(ggplot(fullbins[which(fullbins$ID == binID),])+
      # geom_point(aes(scan, intensity, colour = DQSC), size = 2)+
      geom_col(aes(scan, intensity, fill = DQSB_scaled), colour = NA, width = 0.3)+
      scale_fill_continuous()+
      # scale_color_viridis_c()+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID])))
      readline("Press Enter to return to bin")
    } else {
      buf = as.numeric(input)
      if(!is.na(buf)){
        binID = buf}
    }
  }
}


binSelectionViewer = function(summary, fullbins, IDvector){
  
  IDpos = 1
  binID = IDvector[IDpos]
  rateNext = T
  while (rateNext) {
    ppm2.5 = summary$mean_mz[which(summary$ID == binID)] * 2.5 * 10^-6
    meanMZ = summary$mean_mz[which(summary$ID == binID)]
    stdev = summary$stdev_mz[which(summary$ID == binID)]
    
    print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(mz, scan, color = intensity))+ 
      geom_vline(xintercept = meanMZ - ppm2.5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = meanMZ + ppm2.5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = meanMZ - stdev, linewidth = 0.2, linetype = "dashed", color = "red")+
      geom_vline(xintercept = meanMZ + stdev, linewidth = 0.2, linetype = "dashed", color = "red")+  
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID]))
    )
    input = readline()
    if(input == "#"){
      rateNext = F
    } else if(input == ""){
      IDpos = IDpos + 1
      binID = IDvector[IDpos]
    } else if(input == "<") {
      IDpos = IDpos - 1
      binID = IDvector[IDpos]
    } else if(input == "p"){
      print(ggplot(fullbins[which(fullbins$ID == binID),])+
      # geom_point(aes(scan, intensity, colour = DQSC), size = 2)+
      geom_col(aes(scan, intensity, fill = DQSC), colour = NA, width = 0.3)+

      scale_fill_continuous()+
      theme_bw()+
      # scale_color_viridis_c()+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID])))
      readline("Press Enter to return to bin")
    } else {
      buf = as.numeric(input)
      if(!is.na(buf)){
        IDpos = IDpos + buf
        binID = IDvector[IDpos]
      }
    }
  }
}
```

```{r plotting}
targetBin = bins[which(bins$ID == 730),]
binID = c(700,701)
ggplot(bins[which(bins$ID == binID),])+
  geom_point(aes(mz, scan, color = intensity))+ 
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] - 0.002, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] + 0.002, linewidth = 0.2, linetype = "dashed")+
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID]))
    

ggplot(targetBin)+
 geom_point(aes(scan, intensity))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSC))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_base))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_scaled))

ggplot(targetBin)+
 geom_point(aes(mz, intensity))
  
  
```

```{r subset ratios}
mz1 = c(5.58,2.72,1.65,1.58)
mz2 = c(6.21,5.12,2.42,2.5)

ggplot()+
  geom_point(aes(y = mz1, x = 1:4), color = "red1")+
  geom_point(aes(y = mz2, x = 1:4), color = "lightblue3")

tmp = (bins[which(bins$ID == 30050),])
tmp = tmp[order(tmp$intensity),]
vcrit = critVal(length(tmp$ID)) * std(tmp$intensity)

ggplot()+
  geom_point(aes(diff(tmp$intensity), 2:length(tmp$ID)))+
  geom_hline(yintercept = vcrit)


testcount = 0 # summary: 1879
for (i in 1:length(s_full_1$ID)) {
  tmp = (bins[which(bins$ID == i),])
  tmp = tmp[order(tmp$intensity),]
  vcrit = critVal(length(tmp$ID)) * sd(tmp$intensity)
  if(max(diff(tmp$intensity)) > vcrit){
    testcount = testcount + 1
  }
}


```

