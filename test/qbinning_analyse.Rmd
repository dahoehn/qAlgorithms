---
title: "Analysis qbinning"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
library(TeachingDemos)
library(pracma)

makeDQS <- function(MID, MOD){
  dqs = (MOD - MID) * (1 / (1 + MID)) / max(MID, MOD)
  dqs = (dqs + 1) / 2
  return(dqs)
}
critVal <- function(n){
  ## Function generating the critical mz difference using order statistics
  
  critVal <- 3.05037165842070*log(n)^(-0.4771864667153)
  return(critVal)
}
```

```{r check bin summary}
summary <- read.csv("../../results/210229_C1_S1_W_MI_1_pos_summary.csv")
bins <- read.csv("../../results/210229_C1_S1_W_MI_1_pos_selectBins_full.csv")




```

```{r error analysis}
points_total = 3568033
bins_total = 55910
notbinned_total = 1102746

# summary <- read.csv("C:/Users/unisys/Documents/Studium/Analytik-Praktikum/qAlgorithms/selectBins_summary.csv")

# "../../selectbins_summary.csv"
# bins <- read.csv("../../selectbins_full.csv")
# notbinned = read.csv("../../qbinning_notbinned.csv")
summary$errorcode = as.numeric(lapply(summary$errorcode, bits))
summary$errorcode = summary$errorcode - 10000000

summary = summary[order(summary$size, decreasing = TRUE),]

summary %>% group_by(errorcode) %>% summarise(bin_count = n(), total_points = sum(size), ratio = sum(size)/n(), dqsCen = mean(DQSC_min)) 

stats = as.data.frame(table(summary$errorcode)) # alle ungeraden Zahlen haben duplikate
stats$Var1 = as.numeric(levels(stats$Var1))



```

```{r binviewer and rater}
# last_viewed_bin = 646
# 
# binRater(summary,bins,last_viewed_bin)
# 
# # summary$manual[83]

binViewer = function(summary, fullbins, binID){
 
  readline("Press Enter to continue.")
  rateNext = T
  while (rateNext) {
    ppm5 = summary$mean_mz[which(summary$ID == binID)] * 5 * 10^-6
    print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(mz, scan, color = intensity))+ 
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] - ppm5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] + ppm5, linewidth = 0.2, linetype = "dashed")+
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID]))
    )
    input = readline()
    if(input == "#"){
      rateNext = F
    } else if(input == ""){
      binID = binID + 1
    } else if(input == "<") {
      binID = binID - 1
    } else if(input == "p"){
      print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(scan, intensity, colour = mz))+
      scale_color_viridis_c()+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[binID])))
      readline("Press Enter to return to bin")
    } else {
      buf = as.numeric(input)
      if(!is.na(buf)){
        binID = buf}
    }
  }
}
```

```{r plotting}
targetBin = bins[which(bins$ID == 7),]

ggplot(targetBin)+
  geom_point(aes(mz, scan, color = intensity))+ # , color = as.factor(ID)
  xlab("m/z")+
  ylab("Scan Number")+
  theme(panel.background = element_rect(fill = "lightblue1",
                                colour = "lightblue1",
                                linewidth = 0.5, linetype = "solid"))+
  scale_color_viridis_c(option = "plasma", direction = -1)+
  labs(caption = sprintf("Errorcode: %d", summary$errorcode[22]))


ggplot(targetBin)+
 geom_point(aes(scan, intensity))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSC))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_base))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_scaled))

ggplot(targetBin)+
 geom_point(aes(mz, intensity))
  
  
```

