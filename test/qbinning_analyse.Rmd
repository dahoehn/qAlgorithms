---
title: "Analysis qbinning"
author: "Daniel Höhn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
library(TeachingDemos)
library(pracma)

makeDQS <- function(MID, MOD){
  dqs = (MOD - MID) * (1 / (1 + MID)) / max(MID, MOD)
  dqs = (dqs + 1) / 2
  return(dqs)
}
critVal <- function(n){
  ## Function generating the critical mz difference using order statistics
  
  critVal <- 3.05037165842070*log(n)^(-0.4771864667153)
  return(critVal)
}
```

```{r new bin}
monobin = read.csv("../../rawdata/monobin_base.csv")
monobin = monobin[which(1912 < monobin$scans & monobin$scans < 1958),]

# erstelle je 1 Eintrag für alle scans zwischen 1913 und 1957
for (i in 1913:1957) {
  r = runif(1, 2, 4)
  a = c(55*r, r*r/1000000, runif(1, 700, 2000), i, 1, -1, 0, -1)
  monobin = rbind(monobin, a)
}
for (i in 1:length(monobin$mz)) {
  t1 = c(monobin$mz[i]*runif(1, 2, 3), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  t2 = c(monobin$mz[i]*runif(1, 2, 4), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  monobin = rbind(monobin, t1)
  monobin = rbind(monobin, t2)
}
monobin$rt = monobin$scans * 0.65
monobin = monobin[with(monobin, order(scans, mz)), ]

# write.csv(monobin, "../../rawdata/monobin.csv", row.names = FALSE)

# für R:
monoR = read.csv("../../rawdata/monobin.csv")[,-8]
write.csv(monoR, "../../rawdata/monobinForR.csv", row.names = FALSE)

```

```{r artificial bin}
artmz = rep(c(200,300,400), each = 10)
artmz = artmz + runif(30, 0.0001, 0.0009)
arterror = artmz * 0.000005
artscan = c(1:10, 6:15, 11:20)

artbin = data.frame(mz = artmz, error = arterror, rt = NA, scans = artscan, intensity = 1, ID = c(rep(1:3, each = 10)), DQScen = 0.99, DQSbin = 0.99)

out1 = c(215, 0.001, NA, 2, 1, 0, 0.1, 0.1)
out2 = c(300.5, 0.0015, NA, 20, 1, 0, 0.1, 0.1)

artbin = rbind(artbin, out1, out2)
artbin$rt = 0.65 * artbin$scans + 1

# write.csv(artbin, "../../rawdata/artbin.csv", row.names = FALSE)
```

```{r timings}
# all times in nanoseconds

subsetMZ_r = c(2532043400, 519514200, 63991800, 4207800, 318200, 44400)
subsetScan_r = c(451073000, 345650500, 32338100, 2404200, 182500, 15000)

sum(subsetMZ_r) * 10^-9
sum(subsetScan_r) * 10^-9


subsetMZ_i = c(1058070300, 208686400, 25039300, 1755800, 144200, 9500)
subsetScan_i = c(186643200, 148777100, 14468300, 936100, 49800, 5400)

sum(subsetMZ_i) * 10^-9
sum(subsetScan_i) * 10^-9
```

```{r merge}
prebinned <- read.csv("../../rawdata/control_bins_base.csv")
rawdata <- read.csv("../../rawdata/qCentroid_Warburg_pos_171123_01_Zu_01.csv")
prebinned$mzError <- rawdata$Centroid.Error
#mz column, centroid error column, RT column, scan number column, control ID column 
export <- data.frame(mz = prebinned$mz, mzError = prebinned$mzError, RT = prebinned$rt, scanNo = prebinned$scanNo, intensity = prebinned$intensity, controlID = prebinned$ID, controlCentroidDQS = prebinned$DQScen, controlBinDQS = prebinned$DQSbin)

write.csv(export, "../../rawdata/control_bins_full.csv", row.names = FALSE)
getwd()
```

```{r check bin summary}
summary_norm <- read.csv("../../selectBins_summary_norm.csv")
summary_redo <- read.csv("../../selectBins_summary_redo.csv")
redoneBins <- read.csv("../../redoneBins_summary.csv")
# re-binning reduced bad binning by 355 bins 
sum(summary_redo$mean_mz %in% summary_norm$mean_mz) # 4048
sum(summary_redo$DQSC_min %in% summary_norm$DQSC_min) # 4332
# 4048 bins remain unchanged, while 284 were expanded but still have bad neighbours
selector = !(redoneBins$mean_mz %in% summary_redo$mean_mz)
newGoodBins = redoneBins[selector,] # 1458 new error(only 2 and 3)-free bins with mean DQSB of 0.82; generally even distribution in mz/scans, average size of 14


```

```{r error analysis}
points_total = 3568033
bins_total = 55910
notbinned_total = 1102746

summary <- read.csv("C:/Users/unisys/Documents/Studium/Analytik-Praktikum/qAlgorithms/selectBins_summary.csv")

# "../../selectbins_summary.csv"
# bins <- read.csv("../../selectbins_full.csv")
# notbinned = read.csv("../../qbinning_notbinned.csv")
summary$errorcode = as.numeric(lapply(summary$errorcode, bits))
summary$errorcode = summary$errorcode - 10000000

summary = summary[order(summary$size, decreasing = TRUE),]

summary %>% group_by(errorcode) %>% summarise(bin_count = n(), total_points = sum(size), ratio = sum(size)/n(), dqsCen = mean(DQSC_min)) 

stats = as.data.frame(table(summary$errorcode)) # alle ungeraden Zahlen haben duplikate
stats$Var1 = as.numeric(levels(stats$Var1))



```

```{r binviewer and rater}
last_viewed_bin = 646

binRater(summary,bins,last_viewed_bin)

summary$manual[83]

binViewer = function(summary, fullbins, binID){
 
  readline("Press Enter to continue.")
  rateNext = T
  while (rateNext) {
    ppm5 = summary$mean_mz[which(summary$ID == binID)] * 5 * 10^-6
    print(ggplot(fullbins[which(fullbins$ID == binID),])+
      geom_point(aes(mz, scan, color = intensity))+ 
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] - ppm5, linewidth = 0.2, linetype = "dashed")+
      geom_vline(xintercept = summary$mean_mz[which(summary$ID == binID)] + ppm5, linewidth = 0.2, linetype = "dashed")+
      xlab("m/z")+
      ylab("Scan Number")+
      theme(panel.background = element_rect(fill = "lightblue1",
            colour = "lightblue1", linewidth = 0.5, linetype = "solid"))+
      scale_color_viridis_c(option = "plasma", direction = -1)+
      labs(caption = sprintf("BinID: %d | Errorcode: %d", binID, summary$errorcode[1]))
    )
    input = readline()
    if(input == "#"){
      rateNext = F
    } else if(input == ""){
      binID = binID + 1
    } else if(input == "<") {
      binID = binID - 1
    } else {
      binID = as.numeric(input)
    }
  }
}
```

```{r plotting}
targetBin = bins[which(bins$ID == 7),]

ggplot(targetBin)+
  geom_point(aes(mz, scan, color = intensity))+ # , color = as.factor(ID)
  xlab("m/z")+
  ylab("Scan Number")+
  theme(panel.background = element_rect(fill = "lightblue1",
                                colour = "lightblue1",
                                linewidth = 0.5, linetype = "solid"))+
  scale_color_viridis_c(option = "plasma", direction = -1)+
  labs(caption = sprintf("Errorcode: %d", summary$errorcode[22]))


ggplot(targetBin)+
 geom_point(aes(scan, intensity))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSC))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_base))

ggplot(targetBin)+
 geom_point(aes(scan, intensity * DQSB_scaled))

ggplot(targetBin)+
 geom_point(aes(mz, intensity))
  
  
```

