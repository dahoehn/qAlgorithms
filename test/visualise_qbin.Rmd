---
title: "Untitled"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggfortify)
library(plotly)
```

```{r}
peakStats = as.data.frame(read.csv("C:/Users/unisys/Documents/Studium/Messdaten/scores_19.08.csv"))
peakStats$polarity = peakStats$polarity == 1
peakStats$year = str_extract(peakStats$filename , "^...")
peakStats$year[13] = "error"
peakStats = peakStats[-1,]
peakStats = peakStats[-33,]

```

```{r}
pca_peaks = prcomp(peakStats[which(peakStats$polarity == T), 1:6], scale = T)
pca_peaks$rotation = pca_peaks$rotation * -1

pca_peaks$sdev^2 / sum(pca_peaks$sdev^2)

biplot(pca_peaks, scale = T)

autoplot(pca_peaks, data = peakStats[which(peakStats$polarity),], colour = 'year',

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3) 



###########

pca_peaks2 = prcomp(peakStats[which(!peakStats$polarity), 1:6], scale = T)
pca_peaks2$rotation = pca_peaks2$rotation * -1

pca_peaks2$sdev^2 / sum(pca_peaks2$sdev^2)

biplot(pca_peaks2, scale = T)
```
```{r}
ggplot(peakStats[1:32,])+
  geom_point(aes(filename, numCens / numBins))+
  scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numBins / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numCens / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r}
emptybins = read.csv("./emptybins.csv")
# plot(emptybins)
bintypes = read.csv("./bintypes.csv")
aqflow = read.csv("./aquaflow_crit2.csv")
aqflow$type1 = str_extract(aqflow$file, "[A-Z].")
aqflow$type2 = str_extract(aqflow$file, "[A-Z]._I")

ggplot(emptybins)+
  geom_hex(aes(mz,RT))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, onlyOne/numFull, colour = type2))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, numPeaks/numFull, colour = type1))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(bintypes)+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[42:57,][-8,])+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r for all 94 sets}
allProcessed = read.csv("../log_qBinning_beta.csv", comment.char = "#")
allProcessed = allProcessed[order(allProcessed$filename),]

allProcessed = as.data.frame(allProcessed[,2:(length(allProcessed[1,]))], row.names = allProcessed[,1])

allProcessed$polarity = str_ends(row.names(allProcessed), "pos")
allProcessed$year = str_extract(row.names(allProcessed) , "^..")
allProcessed$blank = str_detect(row.names(allProcessed), "H2O")
allProcessed$blank[1:3] = TRUE

numericCols = c(2,4,5,6,8)
allProcessed[,numericCols] = allProcessed[,numericCols]/allProcessed$numSpectra

pca_all = prcomp(allProcessed[, 2:9], scale = T )
pca_all$rotation = pca_all$rotation * -1

# [which(allProcessed$year == '21'),]

# pca_all$sdev^2 / sum(pca_all$sdev^2)

fullPCA = autoplot(pca_all, data = allProcessed[,], label = T, 
              label.size = 3.2, colour = 'year', shape = F,

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3)

ggplotly(fullPCA)

noBlanks = allProcessed[which(!allProcessed$blank & allProcessed$polarity),]
seriesBreaks = c(1, 24, 40, 58)
breakNames = c("29.02", "11.03", "ozonation", "PFAS")
ggplot()+
  geom_line(aes(1:62, (diff(noBlanks$meanDQSC)), colour = "DQSC"), linewidth = 1)+
  geom_line(aes(1:62, (diff(noBlanks$meanDQSB)), colour = "DQSB"), linewidth = 0.8)+
  geom_line(aes(1:62, (diff(noBlanks$meanDQSF)), colour = "DQSF"), linewidth = 0.6)+
  geom_vline(xintercept = seriesBreaks, linewidth = 1, linetype = "dashed")
  
```

