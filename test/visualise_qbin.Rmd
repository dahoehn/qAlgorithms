---
title: "Untitled"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggfortify)
library(plotly)
```

```{r}
peakStats = as.data.frame(read.csv("C:/Users/unisys/Documents/Studium/Messdaten/scores_19.08.csv"))
peakStats$polarity = peakStats$polarity == 1
peakStats$year = str_extract(peakStats$filename , "^...")
peakStats$year[13] = "error"
peakStats = peakStats[-1,]
peakStats = peakStats[-33,]

```

```{r}
pca_peaks = prcomp(peakStats[which(peakStats$polarity == T), 1:6], scale = T)
pca_peaks$rotation = pca_peaks$rotation * -1

pca_peaks$sdev^2 / sum(pca_peaks$sdev^2)

biplot(pca_peaks, scale = T)

autoplot(pca_peaks, data = peakStats[which(peakStats$polarity),], colour = 'year',

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3) 



###########

pca_peaks2 = prcomp(peakStats[which(!peakStats$polarity), 1:6], scale = T)
pca_peaks2$rotation = pca_peaks2$rotation * -1

pca_peaks2$sdev^2 / sum(pca_peaks2$sdev^2)

biplot(pca_peaks2, scale = T)
```

```{r}
ggplot(peakStats[1:32,])+
  geom_point(aes(filename, numCens / numBins))+
  scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numBins / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numCens / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r}
emptybins = read.csv("./emptybins.csv")
# plot(emptybins)
bintypes = read.csv("./bintypes.csv")
aqflow = read.csv("./aquaflow_crit2.csv")
aqflow$type1 = str_extract(aqflow$file, "[A-Z].")
aqflow$type2 = str_extract(aqflow$file, "[A-Z]._I")

ggplot(emptybins)+
  geom_hex(aes(mz,RT))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, onlyOne/numFull, colour = type2))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, numPeaks/numFull, colour = type1))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(bintypes)+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[42:57,][-8,])+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r for all 94 sets}
allProcessed = read.csv("../log_qBinning_beta.csv", comment.char = "#")


allProcessed = as.data.frame(allProcessed[,2:(length(allProcessed[1,]))], row.names = allProcessed[,1])
# normalise errors of peakfinding to number of features
allProcessed$badFeatures = allProcessed$badFeatures / allProcessed$numFeatures
allProcessed$impossibleRegs = allProcessed$impossibleRegs / allProcessed$numFeatures


allProcessed$polarity = str_ends(row.names(allProcessed), "positive")
allProcessed$year = str_extract(row.names(allProcessed) , "^......")
allProcessed$year = as.numeric(allProcessed$year)
negatives = which(!allProcessed$polarity)
allProcessed$year[negatives] = allProcessed$year[negatives] * -1

allProcessed$blank = (str_detect(row.names(allProcessed), "H2O") | str_detect(row.names(allProcessed), "Blank"))
allProcessed$series = "none"
allProcessed$series[which(allProcessed$year == 202401)] = "PFAS+"
allProcessed$series[which(allProcessed$year == -202401)] = "PFAS-"
allProcessed$series[which(allProcessed$year == 202408)] = "pump_error+"
allProcessed$series[which(allProcessed$year == 210229)] = "Aquaflow_D1+"
allProcessed$series[which(allProcessed$year == 210229 & allProcessed$blank)] = "Aquaflow_D1_B+"
allProcessed$series[which(allProcessed$year == 210311)] = "Aquaflow_D2+"
allProcessed$series[which(allProcessed$year == 220909)] = "Indigo+"
allProcessed$series[which(allProcessed$year == -220909)] = "Indigo-"
allProcessed$series[which(allProcessed$year == 240123)] = "SFC_DoE+"
allProcessed$series[which(allProcessed$year == -240123)] = "SFC_DoE-"
allProcessed$series[which(allProcessed$year == 240821)] = "stds_deca+"


allProcessed = allProcessed[order(allProcessed$series),]

numericCols = c(2,4,5,6,8)
allProcessed[,numericCols] = allProcessed[,numericCols]/allProcessed$numSpectra

pca_all = prcomp(allProcessed[, c(2:8,11)], scale = T )
pca_all$rotation = pca_all$rotation * -1

# [which(allProcessed$year == '21'),]

# pca_all$sdev^2 / sum(pca_all$sdev^2)

fullPCA = autoplot(pca_all, data = allProcessed[,], label = F, 
              label.size = 3.2, colour = 'series', shape = T,

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3)

ggplotly(fullPCA)

### only use these for related data so the scaling stays ok ###
# mark breaks between series in graphs
relativeSD = sd(allProcessed$numCentroids[120:129]) / mean(allProcessed$numCentroids[120:129])
DQSC_SD = sd(allProcessed$meanDQSC[120:129])
sd_bin1 = sd(allProcessed$numBins_one[120:129])
sd_bin0 = sd(allProcessed$numBins_empty[120:129])
sd_bin2 = sd(allProcessed$numBins_more[120:129])
selectedProcess = allProcessed[c(1:44, 120:129), ]
seriesBreaks = (selectedProcess$series[-1] != selectedProcess$series[-length(selectedProcess$series)])
seriesBreaks = which(seriesBreaks) + 0.5


xaxis = 1:(length(selectedProcess$numSpectra)-1)

breakNames = c("Standards", "29.02", "11.03", "ozonation", "PFAS")
s1 = max(diff(selectedProcess$meanDQSC))
s2 = max(diff(selectedProcess$numCentroids))

delim = 10 * max(relativeSD / s2, DQSC_SD / s1)

ggplot()+
  geom_line(aes(xaxis, (diff(selectedProcess$meanDQSC))/s1, colour = "DQSC"), linewidth = 1, alpha = 0.8)+
  geom_line(aes(xaxis, diff(selectedProcess$numCentroids)/s2, colour = "count"), linewidth = 0.85, alpha = 0.8)+
#  geom_line(aes(xaxis, (diff(noBlanks$meanDQSB)), colour = "DQSB"), linewidth = 0.8)+
#  geom_line(aes(xaxis, (diff(noBlanks$meanDQSF)), colour = "DQSF"), linewidth = 0.6)+
  geom_vline(xintercept = seriesBreaks, linewidth = 0.6, linetype = "dashed", alpha = 0.5)+
  geom_hline(yintercept = c(delim, -delim), linewidth = 0.4, colour = "green3")+
  geom_hline(yintercept = c(delim * 10, -delim * 10), linewidth = 0.4, colour = "red")

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), numBins_empty, colour = series, shape = "empty"))+
  geom_point(aes(row.names(selectedProcess), numBins_one, colour = series, shape = "one"))+
  geom_point(aes(row.names(selectedProcess), numBins_more, colour = series, shape = "more"))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), numBins_empty * numBins_more, colour = series))+
  scale_x_discrete(guide = guide_axis(angle = 60))

# absolute deviation from mean / sd of control?
deviations = selectedProcess %>% group_by(series) %>% summarise(b1 = mean(numBins_one), b0 = mean(numBins_empty), b2 = mean(numBins_more))
display_b1 = 0
display_b0 = 0
display_b2 = 0
for (i in 1:length(selectedProcess$numSpectra)) {
  display_b1[i] = (selectedProcess$numBins_one[i] - deviations$b1[
    which(deviations$series == selectedProcess$series[i])])
  display_b0[i] = (selectedProcess$numBins_empty[i] - deviations$b0[
    which(deviations$series == selectedProcess$series[i])])
  display_b2[i] = (selectedProcess$numBins_more[i] - deviations$b2[
    which(deviations$series == selectedProcess$series[i])])
}
display_devs = data.frame(min = 1:length(display_b0), max = 1:length(display_b0), mean = 1:length(display_b0))
for (i in 1:length(display_b0)) {
  display_devs$min[i] = min(display_b1[i], display_b0[i], display_b2[i])
  display_devs$max[i] = max(display_b1[i], display_b0[i], display_b2[i])
  display_devs$mean[i] = mean(display_b1[i], display_b0[i], display_b2[i])
}


ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), display_b1 / sd_bin1, colour = series, shape = "One"))+
  geom_point(aes(row.names(selectedProcess), display_b2 / sd_bin2, colour = series, shape = "Multiple"))+
  geom_point(aes(row.names(selectedProcess), display_b1 / sd_bin1, colour = series, shape = "None"))

# Observation: the three points are very similar for the triplicate blank
ggplot(selectedProcess)+
  geom_linerange(aes(row.names(selectedProcess), 
                     ymin = display_devs$min, ymax = display_devs$max, colour = series),
                 linewidth = 1.4)

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), numFeatures/(numBins_one + numBins_more), colour = series))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), numBins_empty/(numBins_one + numBins_more), colour = series))+
  scale_x_discrete(guide = guide_axis(angle = 60))

# ggplot(selectedProcess)+ # no clear differentiation
#   geom_point(aes(row.names(selectedProcess), numBins_more/(numBins_one), colour = series))+
#   scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), numBins_empty/(numCentroids), colour = series))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(selectedProcess)+
  geom_point(aes(row.names(selectedProcess), (numBins_more + numBins_one)/numFeatures, colour = series))+
  scale_x_discrete(guide = guide_axis(angle = 60))

# ggplot(selectedProcess)+ # removed - no useful information and not a sensible relation
#   geom_point(aes(row.names(selectedProcess), (numBins_empty)/numFeatures, colour = series))+
#   scale_x_discrete(guide = guide_axis(angle = 60))

# ggplot(selectedProcess)+
#   geom_point(aes(x = 1:91, y = diff(numCentroids/(numBins_empty + numBins_one + numBins_more)), colour = series))+
#   scale_x_discrete(guide = guide_axis(angle = 60))
```

