---
title: "Untitled"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggfortify)
library(plotly)
```

```{r}
peakStats = as.data.frame(read.csv("C:/Users/unisys/Documents/Studium/Messdaten/scores_19.08.csv"))
peakStats$polarity = peakStats$polarity == 1
peakStats$year = str_extract(peakStats$filename , "^...")
peakStats$year[13] = "error"
peakStats = peakStats[-1,]
peakStats = peakStats[-33,]

```

```{r}
pca_peaks = prcomp(peakStats[which(peakStats$polarity == T), 1:6], scale = T)
pca_peaks$rotation = pca_peaks$rotation * -1

pca_peaks$sdev^2 / sum(pca_peaks$sdev^2)

biplot(pca_peaks, scale = T)

autoplot(pca_peaks, data = peakStats[which(peakStats$polarity),], colour = 'year',

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3) 



###########

pca_peaks2 = prcomp(peakStats[which(!peakStats$polarity), 1:6], scale = T)
pca_peaks2$rotation = pca_peaks2$rotation * -1

pca_peaks2$sdev^2 / sum(pca_peaks2$sdev^2)

biplot(pca_peaks2, scale = T)
```

```{r}
ggplot(peakStats[1:32,])+
  geom_point(aes(filename, numCens / numBins))+
  scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numBins / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
ggplot(peakStats[1:32,])+
    geom_point(aes(filename, numCens / numPeaks))+
    scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r}
emptybins = read.csv("./emptybins.csv")
# plot(emptybins)
bintypes = read.csv("./bintypes.csv")
aqflow = read.csv("./aquaflow_crit2.csv")
aqflow$type1 = str_extract(aqflow$file, "[A-Z].")
aqflow$type2 = str_extract(aqflow$file, "[A-Z]._I")

ggplot(emptybins)+
  geom_hex(aes(mz,RT))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, onlyOne/numFull, colour = type2))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[1:41,])+
  geom_point(aes(file, numPeaks/numFull, colour = type1))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(bintypes)+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))

ggplot(aqflow[42:57,][-8,])+
  geom_point(aes(file, numPeaks/numFull))+
  scale_x_discrete(guide = guide_axis(angle = 60))
```

```{r for all 94 sets}
allProcessed = read.csv("../log_qBinning_beta.csv", comment.char = "#")


allProcessed = as.data.frame(allProcessed[,2:(length(allProcessed[1,]))], row.names = allProcessed[,1])
# normalise errors of peakfinding to number of features
allProcessed$badFeatures = allProcessed$badFeatures / allProcessed$numFeatures
allProcessed$impossibleRegs = allProcessed$impossibleRegs / allProcessed$numFeatures


allProcessed$polarity = str_ends(row.names(allProcessed), "positive")
allProcessed$year = str_extract(row.names(allProcessed) , "^......")
allProcessed$year = as.numeric(allProcessed$year)
negatives = which(!allProcessed$polarity)
allProcessed$year[negatives] = allProcessed$year[negatives] * -1

allProcessed$blank = (str_detect(row.names(allProcessed), "H2O") | str_detect(row.names(allProcessed), "Blank"))
allProcessed$Series = "none"
allProcessed$Series[which(allProcessed$year == 202401)] = "PFAS+"
allProcessed$Series[which(allProcessed$year == -202401)] = "PFAS-"
allProcessed$Series[which(allProcessed$year == 202402)] = "PFAS+"
allProcessed$Series[which(allProcessed$year == -202402)] = "PFAS-"
allProcessed$Series[which(allProcessed$year == 202408)] = "pump_error+"
allProcessed$Series[which(allProcessed$year == 210229)] = "Aquaflow_D1+"
allProcessed$Series[which(allProcessed$year == 210229 & allProcessed$blank)] = "Aquaflow_D1_B+"
allProcessed$Series[which(allProcessed$year == 210311)] = "Aquaflow_D2+"
allProcessed$Series[which(allProcessed$year == 220909)] = "Indigo+"
allProcessed$Series[which(allProcessed$year == -220909)] = "Indigo-"
allProcessed$Series[which(allProcessed$year == 240123)] = "SFC_DoE+"
allProcessed$Series[which(allProcessed$year == -240123)] = "SFC_DoE-"
allProcessed$Series[which(allProcessed$year == 240821)] = "stds_deca+"
allProcessed$name = str_replace(str_sub(row.names(allProcessed), 7, -8), "pos_p", "p")
allProcessed$name = str_replace(str_replace(allProcessed$name, "^_", ""), "neg_n", "n")
allProcessed$name = str_replace(allProcessed$name, "05_AA_DK_Ibu_pH6", "PE")
allProcessed$name = str_replace(allProcessed$name, ".._Kali_Pu_Penc_2.9", "kali")

allProcessed = allProcessed[order(allProcessed$Series),]

numericCols = c(2,4,5,6,8)
allProcessed[,numericCols] = allProcessed[,numericCols]/allProcessed$numSpectra

pca_all = prcomp(allProcessed[, c(2:8,11)], scale = T )
pca_all$rotation = pca_all$rotation * -1

# [which(allProcessed$year == '21'),]

# pca_all$sdev^2 / sum(pca_all$sdev^2)

fullPCA = autoplot(pca_all, data = allProcessed[,], label = F, 
              label.size = 3.2, colour = 'Series', shape = T,

              loadings = TRUE, loadings.colour = 'blue',

              loadings.label = TRUE, loadings.label.size = 3)

ggplotly(fullPCA)

### only use these for related data so the scaling stays ok ###
# mark breaks between Series in graphs
relativeSD = sd(allProcessed$numCentroids[120:129]) / mean(allProcessed$numCentroids[120:129])
DQSC_SD = sd(allProcessed$meanDQSC[120:129])
sd_bin1 = sd(allProcessed$numBins_one[120:129])
sd_bin0 = sd(allProcessed$numBins_empty[120:129])
sd_bin2 = sd(allProcessed$numBins_more[120:129])
sd_binAll = sd(allProcessed$numBins_more[120:129] + allProcessed$numBins_one[120:129])
```

```{r images}
selectedProcess = 
  allProcessed[c(1:44, 120:129), ] # aquaflow
  # allProcessed[c(108:129), ]# SFC-DoE
  # allProcessed[c(93:107, 120:129), ] # pump error
  # allProcessed[c(45:75, 120:129), ] # kali ozonation
  # allProcessed[c(76:92, 120:129), ] # pfas
SeriesBreaks = (selectedProcess$Series[-1] != selectedProcess$Series[-length(selectedProcess$Series)])
SeriesBreaks = which(SeriesBreaks) + 0.5


Sample = as.factor(1:(length(selectedProcess$numSpectra)-1) + 0.5) 
label = selectedProcess$name[-length(Sample)]

breakNames = c("Standards", "29.02", "11.03", "ozonation", "PFAS")
s1 = max(diff(selectedProcess$meanDQSC))
s2 = max(diff(selectedProcess$numCentroids))

delim = 10 * max(relativeSD / s2, DQSC_SD / s1)

ggplot()+
  geom_line(aes(Sample, (diff(selectedProcess$meanDQSC))/s1, group = "DQSC", colour = "DQSC"), linewidth = 1, alpha = 0.8)+
  geom_line(aes(Sample, diff(selectedProcess$numCentroids)/s2, group = "Count", colour = "Count"), linewidth = 0.85, alpha = 0.8)+
#  geom_line(aes(Sample, (diff(noBlanks$meanDQSB)), colour = "DQSB"), linewidth = 0.8)+
#  geom_line(aes(Sample, (diff(noBlanks$meanDQSF)), colour = "DQSF"), linewidth = 0.6)+
  geom_vline(xintercept = SeriesBreaks, linewidth = 0.6, linetype = "dashed", alpha = 0.5)+
  geom_hline(yintercept = c(delim, -delim), linewidth = 0.4, colour = "green3")+
  geom_hline(yintercept = c(delim * 10, -delim * 10), linewidth = 0.4, colour = "red")+
  scale_x_discrete(labels = label, guide = guide_axis(angle = 60))+
  xlab("Sample")+
  ylab("Centroid Dissimilarity")

ggplot(selectedProcess)+
  geom_point(aes(name, numBins_empty, colour = Series, shape = "empty"))+
  geom_point(aes(name, numBins_one, colour = Series, shape = "one"))+
  geom_point(aes(name, numBins_more, colour = Series, shape = "more"))+
  scale_x_discrete(guide = guide_axis(angle = 60))


# absolute deviation from mean / sd of control?
deviations = selectedProcess %>% group_by(Series) %>% summarise(b1 = mean(numBins_one), b0 = mean(numBins_empty), b2 = mean(numBins_more), bAll = mean(numBins_more + numBins_one))
display_b1 = 0
display_b0 = 0
display_b2 = 0
display_bAll = 0
for (i in 1:length(selectedProcess$numSpectra)) {
  # display_b1[i] = (selectedProcess$numBins_one[i] - deviations$b1[
  #   which(deviations$Series == selectedProcess$Series[i])])
  display_b0[i] = (selectedProcess$numBins_empty[i] - deviations$b0[
    which(deviations$Series == selectedProcess$Series[i])])
  # display_b2[i] = (selectedProcess$numBins_more[i] - deviations$b2[
  #   which(deviations$Series == selectedProcess$Series[i])])
  display_bAll[i] = (selectedProcess$numBins_more[i] + selectedProcess$numBins_one[i] - deviations$bAll[
    which(deviations$Series == selectedProcess$Series[i])])
}
display_devs = data.frame(min = 1:length(display_b0), max = 1:length(display_b0), mean = 1:length(display_b0))
for (i in 1:length(display_b0)) {
  display_devs$min[i] = min(display_bAll[i] / sd_binAll, display_b0[i] / sd_bin0)
  display_devs$max[i] = max(display_bAll[i] / sd_binAll, display_b0[i] / sd_bin0)
  # display_devs$mean[i] = mean(display_bAll[i] / sd_binAll, display_b0[i] / sd_bin0)
}



# Observation: the three points are very similar for the triplicate blank
ggplot(selectedProcess)+
  geom_linerange(aes(name[1:length(numSpectra)], 
                     ymin = display_devs$min, ymax = display_devs$max, colour = Series),
                 linewidth = 1.4)+
  scale_x_discrete(guide = guide_axis(angle = 60))+
  xlab("Sample")+
  ylab("Bin Deviation")
   

threesigma = 3 * sd(selectedProcess$numFeatures[(length(selectedProcess$numFeatures) - 9):length(selectedProcess$numFeatures)])

meanlines = selectedProcess %>% group_by(Series) %>% summarise(mean = mean(numFeatures))

ggplot(selectedProcess)+ 
  geom_point(aes(name, numFeatures, colour = Series))+
  geom_errorbar(aes(name, ymin = numFeatures - threesigma, ymax = numFeatures + threesigma, colour = Series))+
  geom_hline(yintercept = meanlines$mean)+
  scale_x_discrete(guide = guide_axis(angle = 60))+
  xlab("Sample")+
  ylab("Feature Count")


```

